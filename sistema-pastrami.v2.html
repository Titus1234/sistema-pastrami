function registrarPago(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (!pedido) return;

            const contenido = `
                <div class="form-group">
                    <label><strong>Pedido:</strong> ${pedido.cliente}</label>
                    <p><strong>Total:</strong> ${pedido.total.toFixed(2)}</p>
                    <p><strong>Pagado:</strong> ${pedido.montoPagado.toFixed(2)}</p>
                    <p style="color: #dc3545;"><strong>Saldo Pendiente:</strong> ${pedido.saldoPendiente.toFixed(2)}</p>
                </div>
                <div class="form-group">
                    <label for="montoPagoModal">Monto a Pagar</label>
                    <input type="number" id="montoPagoModal" step="0.01" min="0" max="${pedido.saldoPendiente}" value="${pedido.saldoPendiente}">
                </div>
                <div class="form-group">
                    <label for="modalidadPagoModal">Modalidad de Pago</label>
                    <select id="modalidadPagoModal">
                        <option value="efectivo">Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                        <option value="mercadopago">MercadoPago</option>
                    </select>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="confirmarPago('${pedidoId}')">
                        <span>üí∞</span> Confirmar Pago
                    </button>
                    <button class="btn btn-secondary" onclick="cerrarModal('modalPago')">
                        Cancelar
                    </button>
                </div>
            `;

            document.getElementById('contenidoModalPago').innerHTML = contenido;
            document.getElementById('modalPago').classList.add('show');
        }

        async function confirmarPago(pedidoId) {
            const montoPago = parseFloat(document.getElementById('montoPagoModal').value);
            const modalidadPago = document.getElementById('modalidadPagoModal').value;

            if (!montoPago || montoPago <= 0) {
                mostrarAlerta('Ingrese un monto v√°lido', 'warning');
                return;
            }

            try {
                const pedido = pedidos.find(p => p.id === pedidoId);
                if (!pedido) return;

                const nuevoMontoPagado = pedido.montoPagado + montoPago;
                const nuevoSaldoPendiente = pedido.total - nuevoMontoPagado;
                const nuevoEstado = nuevoSaldoPendiente <= 0 ? 'preparacion' : 'pendiente';

                if (isOnline) {
                    await db.collection('pedidos').doc(pedidoId).update({
                        montoPagado: nuevoMontoPagado,
                        saldoPendiente: Math.max(0, nuevoSaldoPendiente),
                        estado: nuevoEstado,
                        modalidadPago: modalidadPago
                    });
                } else {
                    pedido.montoPagado = nuevoMontoPagado;
                    pedido.saldoPendiente = Math.max(0, nuevoSaldoPendiente);
                    pedido.estado = nuevoEstado;
                    pedido.modalidadPago = modalidadPago;
                    localStorage.setItem('pedidos', JSON.stringify(pedidos));
                }

                cerrarModal('modalPago');
                mostrarAlerta('Pago registrado correctamente', 'success');
                mostrarPedidos();
                actualizarDashboard();

            } catch (error) {
                console.error('Error al registrar pago:', error);
                mostrarAlerta('Error al registrar pago', 'danger');
            }
        }

        function verDetallesPedido(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (!pedido) return;

            const contenido = `
                <div style="margin-bottom: 20px;">
                    <h5>üë§ Cliente</h5>
                    <p><strong>${pedido.cliente}</strong></p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h5>üì¶ Productos</h5>
                    ${pedido.productos.map(p => `
                        <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee;">
                            <span><strong>${p.idProducto}</strong> - ${p.nombre}</span>
                            <span>x${p.cantidad} = ${p.subtotal.toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>

                <div style="margin-bottom: 20px;">
                    <h5>üöö Entrega</h5>
                    <p><strong>Fecha:</strong> ${new Date(pedido.fechaEntrega).toLocaleDateString()}</p>
                    <p><strong>Turno:</strong> ${pedido.turnoEntrega}</p>
                    <p><strong>Costo:</strong> ${pedido.costoEnvio.toFixed(2)}</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h5>üí≥ Pago</h5>
                    <p><strong>Modalidad:</strong> ${pedido.modalidadPago}</p>
                    <p><strong>Total:</strong> ${pedido.total.toFixed(2)}</p>
                    <p><strong>Pagado:</strong> ${pedido.montoPagado.toFixed(2)}</p>
                    <p><strong>Saldo:</strong> ${pedido.saldoPendiente.toFixed(2)}</p>
                </div>

                <div style="text-align: center;">
                    <button class="btn btn-secondary" onclick="cerrarModal('modalDetalle')">
                        Cerrar
                    </button>
                </div>
            `;

            document.getElementById('contenidoModalDetalle').innerHTML = contenido;
            document.getElementById('modalDetalle').classList.add('show');
        }

        // FUNCIONES DE DASHBOARD Y ESTAD√çSTICAS
        function cargarDashboard() {
            actualizarDashboard();
            cargarResumenActividades();
            cargarPedidosPendientes();
        }

        function actualizarDashboard() {
            // Stats principales
            document.getElementById('totalClientes').textContent = clientes.length;
            document.getElementById('totalProductos').textContent = productos.length;
            
            const hoy = new Date().toISOString().split('T')[0];
            const pedidosHoy = pedidos.filter(p => p.fechaCreacion.split('T')[0] === hoy);
            const ventasHoy = pedidosHoy.reduce((sum, p) => sum + p.montoPagado, 0);
            
            document.getElementById('pedidosHoy').textContent = pedidosHoy.length;
            document.getElementById('ventasHoy').textContent = `${ventasHoy.toFixed(2)}`;
        }

        function cargarResumenActividades() {
            const container = document.getElementById('resumenActividades');
            
            // Productos con stock bajo
            const stockBajo = productos.filter(p => p.stock <= 5 && p.stock > 0);
            const sinStock = productos.filter(p => p.stock === 0);
            
            // Pedidos pendientes
            const pedidosPendientes = pedidos.filter(p => p.activo && (p.estado === 'pendiente' || p.saldoPendiente > 0));
            
            let html = '';
            
            if (sinStock.length > 0) {
                html += `
                    <div class="alert alert-danger">
                        <strong>üö® Sin Stock:</strong> ${sinStock.length} productos sin stock disponible
                    </div>
                `;
            }
            
            if (stockBajo.length > 0) {
                html += `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Stock Bajo:</strong> ${stockBajo.length} productos con stock bajo (‚â§5 unidades)
                    </div>
                `;
            }
            
            if (pedidosPendientes.length > 0) {
                html += `
                    <div class="alert alert-warning">
                        <strong>üí∞ Pagos Pendientes:</strong> ${pedidosPendientes.length} pedidos con saldos pendientes
                    </div>
                `;
            }
            
            if (html === '') {
                html = '<div class="alert alert-success"><strong>‚úÖ Todo en orden:</strong> No hay alertas pendientes</div>';
            }
            
            container.innerHTML = html;
        }

        function cargarPedidosPendientes() {
            const container = document.getElementById('pedidosPendientes');
            const pedidosPendientes = pedidos
                .filter(p => p.activo && p.estado !== 'entregado')
                .sort((a, b) => new Date(a.fechaEntrega) - new Date(b.fechaEntrega))
                .slice(0, 5);
            
            if (pedidosPendientes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No hay pedidos pendientes de entrega</p>';
                return;
            }
            
            let html = '';
            pedidosPendientes.forEach(pedido => {
                const estadoColor = {
                    'pendiente': '#dc3545',
                    'preparacion': '#007bff',
                    'camino': '#28a745'
                };
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                        <div>
                            <strong>${pedido.cliente}</strong><br>
                            <small>Entrega: ${new Date(pedido.fechaEntrega).toLocaleDateString()} - ${pedido.turnoEntrega}</small>
                        </div>
                        <div style="text-align: right;">
                            <span style="color: ${estadoColor[pedido.estado]}; font-weight: bold;">${pedido.estado.toUpperCase()}</span><br>
                            <small>${pedido.total.toFixed(2)}</small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function cargarEstadisticas() {
            actualizarStatsEstadisticas();
            generarReporte();
        }

        function actualizarStatsEstadisticas() {
            const ahora = new Date();
            const inicioMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
            
            // Ventas del mes
            const ventasMes = pedidos
                .filter(p => new Date(p.fechaCreacion) >= inicioMes)
                .reduce((sum, p) => sum + p.montoPagado, 0);
            
            // Clientes nuevos del mes
            const clientesNuevosMes = clientes
                .filter(c => new Date(c.fechaRegistro) >= inicioMes).length;
            
            // Productos vendidos del mes
            const productosVendidosMes = pedidos
                .filter(p => new Date(p.fechaCreacion) >= inicioMes)
                .reduce((sum, p) => sum + p.productos.reduce((pSum, prod) => pSum + prod.cantidad, 0), 0);
            
            // Promedio por venta
            const pedidosPagados = pedidos.filter(p => p.montoPagado > 0);
            const promedioVenta = pedidosPagados.length > 0 ? 
                pedidosPagados.reduce((sum, p) => sum + p.montoPagado, 0) / pedidosPagados.length : 0;
            
            document.getElementById('ventasMensuales').textContent = `${ventasMes.toFixed(2)}`;
            document.getElementById('clientesNuevos').textContent = clientesNuevosMes;
            document.getElementById('productosVendidos').textContent = productosVendidosMes;
            document.getElementById('promedioVenta').textContent = `${promedioVenta.toFixed(2)}`;
        }

        function generarReporte() {
            const periodo = document.getElementById('periodoReporte').value;
            const tipo = document.getElementById('tipoReporte').value;
            const container = document.getElementById('reporteResultados');
            
            // Configurar fechas seg√∫n per√≠odo
            let fechaDesde, fechaHasta;
            const hoy = new Date();
            
            switch(periodo) {
                case 'hoy':
                    fechaDesde = fechaHasta = hoy.toISOString().split('T')[0];
                    break;
                case 'semana':
                    const inicioSemana = new Date(hoy);
                    inicioSemana.setDate(hoy.getDate() - hoy.getDay());
                    fechaDesde = inicioSemana.toISOString().split('T')[0];
                    fechaHasta = hoy.toISOString().split('T')[0];
                    break;
                case 'mes':
                    fechaDesde = new Date(hoy.getFullYear(), hoy.getMonth(), 1).toISOString().split('T')[0];
                    fechaHasta = hoy.toISOString().split('T')[0];
                    break;
                case 'personalizado':
                    fechaDesde = document.getElementById('reporteDesde').value;
                    fechaHasta = document.getElementById('reporteHasta').value;
                    if (!fechaDesde || !fechaHasta) {
                        container.innerHTML = '<div class="alert alert-warning">Seleccione fechas para el per√≠odo personalizado</div>';
                        return;
                    }
                    break;
            }
            
            // Filtrar pedidos por per√≠odo
            const pedidosFiltrados = pedidos.filter(p => {
                const fechaPedido = p.fechaCreacion.split('T')[0];
                return fechaPedido >= fechaDesde && fechaPedido <= fechaHasta;
            });
            
            // Generar reporte seg√∫n tipo
            let html = '';
            
            switch(tipo) {
                case 'ventas':
                    html = generarReporteVentas(pedidosFiltrados, fechaDesde, fechaHasta);
                    break;
                case 'productos':
                    html = generarReporteProductos(pedidosFiltrados);
                    break;
                case 'clientes':
                    html = generarReporteClientes(pedidosFiltrados);
                    break;
                case 'pagos':
                    html = generarReportePagos(pedidosFiltrados);
                    break;
                case 'zonas':
                    html = generarReporteZonas(pedidosFiltrados);
                    break;
            }
            
            container.innerHTML = html;
        }

        function generarReporteVentas(pedidos, fechaDesde, fechaHasta) {
            const totalVentas = pedidos.reduce((sum, p) => sum + p.montoPagado, 0);
            const totalPedidos = pedidos.length;
            const promedio = totalPedidos > 0 ? totalVentas / totalPedidos : 0;
            
            return `
                <div class="item-card">
                    <h4>üìä Reporte de Ventas</h4>
                    <p><strong>Per√≠odo:</strong> ${fechaDesde} al ${fechaHasta}</p>
                    
                    <div class="stats">
                        <div class="stat-card">
                            <h3>${totalVentas.toFixed(2)}</h3>
                            <p>Total Vendido</p>
                        </div>
                        <div class="stat-card">
                            <h3>${totalPedidos}</h3>
                            <p>Pedidos Realizados</p>
                        </div>
                        <div class="stat-card">
                            <h3>${promedio.toFixed(2)}</h3>
                            <p>Promedio por Pedido</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function generarReporteProductos(pedidos) {
            const productosVendidos = {};
            
            pedidos.forEach(pedido => {
                pedido.productos.forEach(prod => {
                    if (!productosVendidos[prod.idProducto]) {
                        productosVendidos[prod.idProducto] = {
                            nombre: prod.nombre,
                            cantidad: 0,
                            ingresos: 0
                        };
                    }
                    productosVendidos[prod.idProducto].cantidad += prod.cantidad;
                    productosVendidos[prod.idProducto].ingresos += prod.subtotal;
                });
            });
            
            const productosOrdenados = Object.entries(productosVendidos)
                .sort((a, b) => b[1].cantidad - a[1].cantidad)
                .slice(0, 10);
            
            let html = `
                <div class="item-card">
                    <h4>üì¶ Productos M√°s Vendidos</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Producto</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">Cantidad</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;">Ingresos</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            productosOrdenados.forEach(([id, data], index) => {
                html += `
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">
                            <strong>${id}</strong> - ${data.nombre}
                        </td>
                        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">
                            ${data.cantidad}
                        </td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6;">
                            ${data.ingresos.toFixed(2)}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            return html;
        }

        function generarReporteClientes(pedidos) {
            const clientesData = {};
            
            pedidos.forEach(pedido => {
                if (!clientesData[pedido.cliente]) {
                    clientesData[pedido.cliente] = {
                        pedidos: 0,
                        gastado: 0
                    };
                }
                clientesData[pedido.cliente].pedidos++;
                clientesData[pedido.cliente].gastado += pedido.montoPagado;
            });
            
            const clientesOrdenados = Object.entries(clientesData)
                .sort((a, b) => b[1].gastado - a[1].gastado)
                .slice(0, 10);
            
            let html = `
                <div class="item-card">
                    <h4>üë• Clientes M√°s Frecuentes</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Cliente</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">Pedidos</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;">Total Gastado</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            clientesOrdenados.forEach(([cliente, data]) => {
                html += `
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">
                            <strong>${cliente}</strong>
                        </td>
                        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">
                            ${data.pedidos}
                        </td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6;">
                            ${data.gastado.toFixed(2)}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            return html;
        }

        function generarReportePagos(pedidos) {
            const modalidades = {};
            
            pedidos.forEach(pedido => {
                if (!modalidades[pedido.modalidadPago]) {
                    modalidades[pedido.modalidadPago] = {
                        cantidad: 0,
                        monto: 0
                    };
                }
                modalidades[pedido.modalidadPago].cantidad++;
                modalidades[pedido.modalidadPago].monto += pedido.montoPagado;
            });
            
            const total = Object.values(modalidades).reduce((sum, m) => sum + m.monto, 0);
            
            let html = `
                <div class="item-card">
                    <h4>üí≥ Modalidades de Pago</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Modalidad</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">Cantidad</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;">Monto</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;">%</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            Object.entries(modalidades).forEach(([modalidad, data]) => {
                const porcentaje = total > 0 ? (data.monto / total * 100) : 0;
                html += `
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">
                            <strong>${modalidad.charAt(0).toUpperCase() + modalidad.slice(1)}</strong>
                        </td>
                        <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">
                            ${data.cantidad}
                        </td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6;">
                            ${data.monto.toFixed(2)}
                        </td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6;">
                            ${porcentaje.toFixed(1)}%
                        </td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            return html;
        }

        function generarReporteZonas(pedidos) {
            // Para este reporte necesitar√≠amos extraer c√≥digos postales de las direcciones
            // Por simplicidad, mostraremos un mensaje
            return `
                <div class="item-card">
                    <h4>üó∫Ô∏è Zonas de Entrega</h4>
                    <div class="alert alert-info">
                        <p>Este reporte estar√° disponible cuando se implementen c√≥digos postales en las direcciones de los clientes.</p>
                        <p>Total de pedidos analizados: ${pedidos.length}</p>
                    </div>
                </div>
            `;
        }

        // FUNCIONES DE UTILIDAD
        function mostrarAlerta(mensaje, tipo) {
            const alertas = document.createElement('div');
            alertas.className = `alert alert-${tipo}`;
            alertas.innerHTML = `<strong>${mensaje}</strong>`;
            alertas.style.position = 'fixed';
            alertas.style.top = '20px';
            alertas.style.right = '20px';
            alertas.style.zIndex = '9999';
            alertas.style.minWidth = '300px';
            
            document.body.appendChild(alertas);
            
            setTimeout(() => {
                alertas.remove();
            }, 4000);
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Cerrar modales al hacer click fuera
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        });

        // INICIALIZACI√ìN
        document.addEventListener('DOMContentLoaded', function() {
            inicializarApp();
            
            // Configurar listeners para filtros
            const periodoReporte = document.getElementById('periodoReporte');
            if (periodoReporte) {
                periodoReporte.addEventListener('change', function() {
                    const fechasDiv = document.getElementById('fechasPersonalizadas');
                    if (this.value === 'personalizado') {
                        fechasDiv.style.display = 'grid';
                        fechasDiv.style.gridTemplateColumns = '1fr 1fr';
                        fechasDiv.style.gap = '15px';
                    } else {
                        fechasDiv.style.display = 'none';
                    }
                });
            }
        });

        // Funciones adicionales que faltaban
        async function editarCliente(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) return;

            const nuevoNombre = prompt('Nuevo nombre:', cliente.nombre);
            if (!nuevoNombre) return;

            const nuevoApellido = prompt('Nuevo apellido:', cliente.apellido);
            if (!nuevoApellido) return;

            const nuevoTelefono = prompt('Nuevo tel√©fono:', cliente.telefono);
            if (!nuevoTelefono) return;

            try {
                if (isOnline) {
                    await db.collection('clientes').doc(clienteId).update({
                        nombre: nuevoNombre,
                        apellido: nuevoApellido,
                        telefono: nuevoTelefono
                    });
                } else {
                    cliente.nombre = nuevoNombre;
                    cliente.apellido = nuevoApellido;
                    cliente.telefono = nuevoTelefono;
                    localStorage.setItem('clientes', JSON.stringify(clientes));
                    mostrarClientes();
                }
                
                mostrarAlerta('Cliente actualizado correctamente', 'success');
            } catch (error) {
                console.error('Error al editar cliente:', error);
                mostrarAlerta('Error al editar cliente', 'danger');
            }
        }

        async function toggleClienteActivo(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) return;

            try {
                const nuevoEstado = !cliente.activo;
                
                if (isOnline) {
                    await db.collection('clientes').doc(clienteId).update({
                        activo: nuevoEstado
                    });
                } else {
                    cliente.activo = nuevoEstado;
                    localStorage.setItem('clientes', JSON.stringify(clientes));
                    mostrarClientes();
                }
                
                mostrarAlerta(`Cliente ${nuevoEstado ? 'activado' : 'desactivado'} correctamente`, 'success');
            } catch (error) {
                console.error('Error al cambiar estado del cliente:', error);
                mostrarAlerta('Error al cambiar estado del cliente', 'danger');
            }
        }

        async function editarProducto(productoId) {
            const producto = productos.find(p => p.id === productoId);
            if (!producto) return;

            const nuevoNombre = prompt('Nuevo nombre:', producto.nombre);
            if (!nuevoNombre) return;

            const nuevoPrecio = prompt('Nuevo precio sugerido:', producto.precioSugerido);
            if (nuevoPrecio === null) return;

            try {
                if (isOnline) {
                    await db.collection('productos').doc(productoId).update({
                        nombre: nuevoNombre,
                        precioSugerido: parseFloat(nuevoPrecio) || 0
                    });
                } else {
                    producto.nombre = nuevoNombre;
                    producto.precioSugerido = parseFloat(nuevoPrecio) || 0;
                    localStorage.setItem('productos', JSON.stringify(productos));
                    mostrarProductos();
                }
                
                mostrarAlerta('Producto actualizado correctamente', 'success');
            } catch (error) {
                console.error('Error al editar producto:', error);
                mostrarAlerta('Error al editar producto', 'danger');
            }
        }

        async function eliminarProducto(productoId) {
            if (!confirm('¬øEst√° seguro de eliminar este producto?')) return;

            try {
                if (isOnline) {
                    await db.collection('productos').doc(productoId).delete();
                } else {
                    const index = productos.findIndex(p => p.id === productoId);
                    if (index !== -1) {
                        productos.splice(index, 1);
                        localStorage.setItem('productos', JSON.stringify(productos));
                        mostrarProductos();
                    }
                }
                
                mostrarAlerta('Producto eliminado correctamente', 'success');
            } catch (error) {
                console.error('Error al eliminar producto:', error);
                mostrarAlerta('Error al eliminar producto', 'danger');
            }
        }

        async function eliminarPedido(pedidoId) {
            if (!confirm('¬øEst√° seguro de eliminar este pedido? Esta acci√≥n no se puede deshacer.')) return;

            try {
                if (isOnline) {
                    await db.collection('pedidos').doc(pedidoId).delete();
                } else {
                    const index = pedidos.findIndex(p => p.id === pedidoId);
                    if (index !== -1) {
                        pedidos.splice(index, 1);
                        localStorage.setItem('pedidos', JSON.stringify(pedidos));
                        mostrarPedidos();
                    }
                }
                
                mostrarAlerta('Pedido eliminado correctamente', 'success');
                actualizarDashboard();
            } catch (error) {
                console.error('Error al eliminar pedido:', error);
                mostrarAlerta('Error al eliminar pedido', 'danger');
            }
        }

        // Event listeners para cerrar modales con Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
            }
        });

        // Funci√≥n para manejar errores de conexi√≥n
        window.addEventListener('online', function() {
            isOnline = true;
            actualizarEstadoConexion(true);
            // Intentar sincronizar datos pendientes
            sincronizarDatosPendientes();
        });

        window.addEventListener('offline', function() {
            isOnline = false;
            actualizarEstadoConexion(false);
        });

        async function sincronizarDatosPendientes() {
            try {
                // Esta funci√≥n se podr√≠a expandir para sincronizar datos que se guardaron localmente mientras no hab√≠a conexi√≥n
                await cargarTodosLosDatos();
                mostrarAlerta('Datos sincronizados correctamente', 'success');
            } catch (error) {
                console.error('Error al sincronizar datos:', error);
            }
        }

        // Funciones para manejo de fechas
        function formatearFecha(fecha) {
            return new Date(fecha).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function obtenerFechaHoy() {
            return new Date().toISOString().split('T')[0];
        }

        // Funci√≥n para exportar datos (opcional)
        function exportarDatos() {
            const datos = {
                clientes: clientes,
                productos: productos,
                pedidos: pedidos,
                fechaExportacion: new Date().toISOString()
            };

            const dataStr = JSON.stringify(datos, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `sistema-pastrami-backup-${obtenerFechaHoy()}.json`;
            link.click();
            
            mostrarAlerta('Datos exportados correctamente', 'success');
        }

        // Agregar bot√≥n de exportar al dashboard (opcional)
        function agregarBotonExportar() {
            const dashboard = document.getElementById('dashboard');
            if (dashboard && !document.getElementById('btnExportar')) {
                const botonExportar = document.createElement('button');
                botonExportar.id = 'btnExportar';
                botonExportar.className = 'btn btn-info';
                botonExportar.innerHTML = '<span>üíæ</span> Exportar Datos';
                botonExportar.onclick = exportarDatos;
                botonExportar.style.position = 'fixed';
                botonExportar.style.bottom = '20px';
                botonExportar.style.right = '20px';
                botonExportar.style.zIndex = '1000';
                
                document.body.appendChild(botonExportar);
            }
        }

        // Llamar despu√©s de cargar el dashboard
        setTimeout(agregarBotonExportar, 1000);

        // Funci√≥n para validar datos antes de guardar
        function validarDatos(tipo, datos) {
            switch(tipo) {
                case 'cliente':
                    return datos.nombre && datos.apellido && datos.telefono;
                case 'producto':
                    return datos.idProducto && datos.nombre && datos.stock >= 0 && datos.tipo;
                case 'pedido':
                    return datos.cliente && datos.productos.length > 0 && datos.fechaEntrega && datos.turnoEntrega;
                default:
                    return false;
            }
        }

        // Funciones de b√∫squeda avanzada
        function busquedaAvanzada(termino, tipo) {
            const terminoLower = termino.toLowerCase();
            
            switch(tipo) {
                case 'clientes':
                    return clientes.filter(c => 
                        c.nombre.toLowerCase().includes(terminoLower) ||
                        c.apellido.toLowerCase().includes(terminoLower) ||
                        c.telefono.includes(termino) ||
                        c.email.toLowerCase().includes(terminoLower)
                    );
                    
                case 'productos':
                    return productos.filter(p => 
                        p.idProducto.toLowerCase().includes(terminoLower) ||
                        p.nombre.toLowerCase().includes(terminoLower)
                    );
                    
                case 'pedidos':
                    return pedidos.filter(p => 
                        p.cliente.toLowerCase().includes(terminoLower) ||
                        p.productos.some(prod => 
                            prod.nombre.toLowerCase().includes(terminoLower) ||
                            prod.idProducto.toLowerCase().includes(terminoLower)
                        )
                    );
                    
                default:
                    return [];
            }
        }

        // Funci√≥n para calcular m√©tricas avanzadas
        function calcularMetricas() {
            const ahora = new Date();
            const hace30Dias = new Date(ahora.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            const pedidosRecientes = pedidos.filter(p => new Date(p.fechaCreacion) >= hace30Dias);
            
            const metricas = {
                ventasUltimos30Dias: pedidosRecientes.reduce((sum, p) => sum + p.montoPagado, 0),
                pedidosUltimos30Dias: pedidosRecientes.length,
                clientesUnicos: new Set(pedidosRecientes.map(p => p.cliente)).size,
                productoMasVendido: calcularProductoMasVendido(pedidosRecientes),
                tasaConversion: calcularTasaConversion(),
                ticketPromedio: calcularTicketPromedio(pedidosRecientes)
            };
            
            return metricas;
        }

        function calcularProductoMasVendido(pedidos) {
            const conteoProductos = {};
            
            pedidos.forEach(pedido => {
                pedido.productos.forEach(prod => {
                    conteoProductos[prod.idProducto] = (conteoProductos[prod.idProducto] || 0) + prod.cantidad;
                });
            });
            
            const masVendido = Object.entries(conteoProductos)
                .sort((a, b) => b[1] - a[1])[0];
            
            return masVendido ? { id: masVendido[0], cantidad: masVendido[1] } : null;
        }

        function calcularTasaConversion() {
            const pedidosCompletados = pedidos.filter(p => p.estado === 'entregado').length;
            const totalPedidos = pedidos.length;
            
            return totalPedidos > 0 ? (pedidosCompletados / totalPedidos * 100).toFixed(1) : 0;
        }

        function calcularTicketPromedio(pedidos) {
            if (pedidos.length === 0) return 0;
            
            const totalVentas = pedidos.reduce((sum, p) => sum + p.total, 0);
            return totalVentas / pedidos.length;
        }

        // Funci√≥n para notificaciones push (si se implementa PWA)
        function solicitarPermisoNotificaciones() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        mostrarAlerta('Notificaciones habilitadas', 'success');
                    }
                });
            }
        }

        function enviarNotificacion(titulo, mensaje) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(titulo, {
                    body: mensaje,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDY0IDY0Ij48dGV4dCB5PSIzMiIgZm9udC1zaXplPSI0MCI+8J+llDwvdGV4dD48L3N2Zz4='
                });
            }
        }

        // Auto-guardado cada 5 minutos (solo si hay cambios)
        let ultimoGuardado = Date.now();
        let hayChangios = false;

        setInterval(() => {
            if (hayChangios && isOnline) {
                // Aqu√≠ se podr√≠a implementar un auto-guardado m√°s sofisticado
                console.log('Auto-guardado ejecutado');
                hayChangios = false;
                ultimoGuardado = Date.now();
            }
        }, 5 * 60 * 1000); // 5 minutos

        // Funci√≥n para marcar que hay cambios
        function marcarCambios() {
            hayChangios = true;
        }

        // Optimizaci√≥n para dispositivos m√≥viles
        function optimizarParaMovil() {
            const esMobile = window.innerWidth <= 768;
            
            if (esMobile) {
                // Ajustar tama√±os de fuente
                document.body.style.fontSize = '14px';
                
                // Ocultar elementos no esenciales en m√≥vil
                const elementosOcultar = document.querySelectorAll('.solo-desktop');
                elementosOcultar.forEach(el => el.style.display = 'none');
                
                // Hacer tabs m√°s t√°ctiles
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.style.minHeight = '44px';
                });
            }
        }

        // Llamar optimizaci√≥n al cargar y redimensionar
        window.addEventListener('resize', optimizarParaMovil);
        document.addEventListener('DOMContentLoaded', optimizarParaMovil);

        // Funci√≥n para debug (solo en desarrollo)
        function debug(mensaje, datos = null) {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log(`[DEBUG] ${mensaje}`, datos);
            }
        }

        // Manejo de errores global
        window.addEventListener('error', function(event) {
            console.error('Error global capturado:', event.error);
            mostrarAlerta('Ha ocurrido un error inesperado', 'danger');
        });

        // Funci√≥n para limpiar datos antiguos (ejecutar peri√≥dicamente)
        function limpiarDatosAntiguos() {
            const hace6Meses = new Date();
            hace6Meses.setMonth(hace6Meses.getMonth() - 6);
            
            // Limpiar pedidos archivados muy antiguos
            const pedidosLimpios = pedidos.filter(p => 
                p.activo || new Date(p.fechaCreacion) > hace6Meses
            );
            
            if (pedidosLimpios.length !== pedidos.length) {
                pedidos = pedidosLimpios;
                localStorage.setItem('pedidos', JSON.stringify(pedidos));
                debug(`Limpieza ejecutada. Pedidos eliminados: ${pedidos.length - pedidosLimpios.length}`);
            }
        }

        // Ejecutar limpieza al cargar (solo una vez por d√≠a)
        const ultimaLimpieza = localStorage.getItem('ultimaLimpieza');
        const hoy = obtenerFechaHoy();

        if (ultimaLimpieza !== hoy) {
            setTimeout(() => {
                limpiarDatosAntiguos();
                localStorage.setItem('ultimaLimpieza', hoy);
            }, 10000); // Ejecutar despu√©s de 10 segundos
        }

        // Mensaje de bienvenida (solo la primera vez)
        const primeraVez = !localStorage.getItem('yaVisito');
        if (primeraVez) {
            setTimeout(() => {
                mostrarAlerta('¬°Bienvenido al Sistema Pastrami! Tu plataforma de gesti√≥n est√° lista.', 'success');
                localStorage.setItem('yaVisito', 'true');
            }, 2000);
        }

        // Configuraci√≥n de Firebase m√°s robusta
        function configurarFirebaseProduccion() {
            // Estas credenciales son de ejemplo. En producci√≥n debes usar las tuyas reales.
            const firebaseConfigProduccion = {
                apiKey: "TU_API_KEY_REAL",
                authDomain: "tu-proyecto.firebaseapp.com", 
                projectId: "tu-proyecto-id",
                storageBucket: "tu-proyecto.appspot.com",
                messagingSenderId: "123456789012",
                appId: "1:123456789012:web:abc123def456ghi789"
            };
            
            // Comentar la l√≠nea de configuraci√≥n de ejemplo y descomentar esta para producci√≥n:
            // firebase.initializeApp(firebaseConfigProduccion);
        }

        console.log('ü•™ Sistema Pastrami cargado correctamente');
        console.log('üì± Versi√≥n: 1.0.0');
        console.log('üîß Modo:', isOnline ? 'Online' : 'Offline');
    </script>
</body>
</html>
                }        function cargarProductos() {
            mostrarProductos();
            actualizarStatsProductos();
            cargarProductosEnComponentes();
        }

        function mostrarProductos() {
            const lista = document.getElementById('listaProductos');
            
            if (productos.length === 0) {
                lista.innerHTML = `
                    <div class="empty-state">
                        <h3>üì¶ No hay productos registrados</h3>
                        <p>Agrega tu primer producto usando el formulario de arriba</p>
                    </div>
                `;
                return;
            }

            let html = '';
            productos.forEach(producto => {
                const stockBadge = producto.stock <= 5 ? 'badge-danger' : producto.stock <= 10 ? 'badge-warning' : 'badge-success';
                const tipoBadge = producto.tipo === 'compuesto' ? 'badge-info' : 'badge-primary';
                
                let componentesHtml = '';
                if (producto.componentes && producto.componentes.length > 0) {
                    componentesHtml = `
                        <div style="margin-top: 10px;">
                            <strong>üìã Componentes:</strong><br>
                            ${producto.componentes.map(c => `‚Ä¢ ${c.idProducto} - ${c.nombre} (x${c.cantidad})`).join('<br>')}
                        </div>
                    `;
                }

                html += `
                    <div class="item-card">
                        <div class="item-header">
                            <div class="item-info">
                                <h4>${producto.idProducto} - ${producto.nombre}</h4>
                                <div style="margin: 10px 0;">
                                    <span class="badge ${tipoBadge}">${producto.tipo.toUpperCase()}</span>
                                    <span class="badge ${stockBadge}">Stock: ${producto.stock}</span>
                                    ${producto.precioSugerido > 0 ? `<span class="badge badge-warning">${producto.precioSugerido.toFixed(2)}</span>` : ''}
                                </div>
                                ${componentesHtml}
                                <p style="color: #666; font-size: 14px;">
                                    üìÖ Creado: ${new Date(producto.fechaCreacion).toLocaleDateString()}
                                </p>
                            </div>
                            <div class="item-actions">
                                <button class="btn btn-info btn-small" onclick="ajustarStock('${producto.id}')">
                                    <span>üìä</span> Stock
                                </button>
                                <button class="btn btn-warning btn-small" onclick="editarProducto('${producto.id}')">
                                    <span>‚úèÔ∏è</span> Editar
                                </button>
                                <button class="btn btn-danger btn-small" onclick="eliminarProducto('${producto.id}')">
                                    <span>üóëÔ∏è</span> Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            lista.innerHTML = html;
        }

        function actualizarStatsProductos() {
            const valorInventario = productos.reduce((total, p) => total + (p.stock * p.precioSugerido), 0);
            document.getElementById('totalProductosTab').textContent = productos.length;
            document.getElementById('valorInventario').textContent = `${valorInventario.toFixed(2)}`;
        }

        function filtrarProductos() {
            const filtroTexto = document.getElementById('searchProductos').value.toLowerCase();
            const filtroTipo = document.getElementById('filtroTipoProducto').value;
            const filtroStock = document.getElementById('filtroStock').value;
            
            const items = document.querySelectorAll('#listaProductos .item-card');
            
            items.forEach(item => {
                const texto = item.textContent.toLowerCase();
                const producto = productos.find(p => item.textContent.includes(p.idProducto));
                
                let mostrar = true;
                
                // Filtro por texto
                if (filtroTexto && !texto.includes(filtroTexto)) {
                    mostrar = false;
                }
                
                // Filtro por tipo
                if (filtroTipo && producto && producto.tipo !== filtroTipo) {
                    mostrar = false;
                }
                
                // Filtro por stock
                if (filtroStock && producto) {
                    if (filtroStock === 'bajo' && producto.stock > 5) mostrar = false;
                    if (filtroStock === 'sin' && producto.stock > 0) mostrar = false;
                }
                
                item.style.display = mostrar ? 'block' : 'none';
            });
        }

        async function ajustarStock(productoId) {
            const producto = productos.find(p => p.id === productoId);
            if (!producto) return;

            const nuevoStock = prompt(`Stock actual: ${producto.stock}\nIngrese el nuevo stock:`, producto.stock);
            if (nuevoStock === null || isNaN(nuevoStock) || nuevoStock < 0) return;

            try {
                if (isOnline) {
                    await db.collection('productos').doc(productoId).update({
                        stock: parseInt(nuevoStock)
                    });
                } else {
                    producto.stock = parseInt(nuevoStock);
                    localStorage.setItem('productos', JSON.stringify(productos));
                    mostrarProductos();
                }
                
                mostrarAlerta('Stock actualizado correctamente', 'success');
            } catch (error) {
                console.error('Error al actualizar stock:', error);
                mostrarAlerta('Error al actualizar stock', 'danger');
            }
        }

        // FUNCIONES DE PEDIDOS
        function cargarPedidos() {
            establecerFechaHoy();
            mostrarPedidos();
            actualizarStatsPedidos();
            cargarClientesEnSelect();
            cargarProductosEnSelect();
        }

        function establecerFechaHoy() {
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaEntrega').value = hoy;
        }

        function buscarClientesAutocomplete() {
            const busqueda = document.getElementById('buscarCliente').value.toLowerCase();
            const select = document.getElementById('clienteSelect');
            
            select.innerHTML = '<option value="">Seleccionar cliente</option>';
            
            if (busqueda.length >= 2) {
                const clientesFiltrados = clientes.filter(c => 
                    c.activo && (
                        c.apellido.toLowerCase().includes(busqueda) ||
                        c.nombre.toLowerCase().includes(busqueda)
                    )
                );
                
                clientesFiltrados.forEach(cliente => {
                    select.innerHTML += `<option value="${cliente.id}">${cliente.apellido}, ${cliente.nombre}</option>`;
                });
            }
        }

        function seleccionarCliente() {
            const clienteId = document.getElementById('clienteSelect').value;
            const cliente = clientes.find(c => c.id === clienteId);
            
            if (cliente) {
                document.getElementById('clienteFinal').value = `${cliente.nombre} ${cliente.apellido}`;
            }
        }

        function buscarProductosAutocomplete() {
            const busqueda = document.getElementById('buscarProducto').value.toLowerCase();
            const select = document.getElementById('productoSelect');
            
            select.innerHTML = '<option value="">Seleccionar producto</option>';
            
            if (busqueda.length >= 2) {
                const productosFiltrados = productos.filter(p => 
                    p.activo && p.stock > 0 && (
                        p.nombre.toLowerCase().includes(busqueda) ||
                        p.idProducto.toLowerCase().includes(busqueda)
                    )
                );
                
                productosFiltrados.forEach(producto => {
                    select.innerHTML += `<option value="${producto.id}">${producto.idProducto} - ${producto.nombre} (Stock: ${producto.stock})</option>`;
                });
            }
        }

        function seleccionarProducto() {
            const productoId = document.getElementById('productoSelect').value;
            const producto = productos.find(p => p.id === productoId);
            
            if (producto && producto.precioSugerido > 0) {
                document.getElementById('precioUnitario').value = producto.precioSugerido.toFixed(2);
            }
        }

        function cargarClientesEnSelect() {
            const select = document.getElementById('clienteSelect');
            select.innerHTML = '<option value="">Seleccionar cliente</option>';
            
            clientes.filter(c => c.activo).forEach(cliente => {
                select.innerHTML += `<option value="${cliente.id}">${cliente.apellido}, ${cliente.nombre}</option>`;
            });
        }

        function cargarProductosEnSelect() {
            const select = document.getElementById('productoSelect');
            select.innerHTML = '<option value="">Seleccionar producto</option>';
            
            productos.filter(p => p.activo && p.stock > 0).forEach(producto => {
                select.innerHTML += `<option value="${producto.id}">${producto.idProducto} - ${producto.nombre} (Stock: ${producto.stock})</option>`;
            });
        }

        function agregarProductoPedido() {
            const productoId = document.getElementById('productoSelect').value;
            const cantidad = parseInt(document.getElementById('cantidadProducto').value);
            const precioUnitario = parseFloat(document.getElementById('precioUnitario').value);

            if (!productoId || !cantidad || !precioUnitario) {
                mostrarAlerta('Complete todos los campos del producto', 'warning');
                return;
            }

            const producto = productos.find(p => p.id === productoId);
            if (!producto) return;

            // Verificar stock disponible
            if (cantidad > producto.stock) {
                mostrarAlerta(`Stock insuficiente. Disponible: ${producto.stock}`, 'warning');
                return;
            }

            // Verificar si ya est√° en el pedido
            const existeIndex = productosDelPedidoActual.findIndex(p => p.productoId === productoId);
            if (existeIndex !== -1) {
                // Actualizar cantidad
                productosDelPedidoActual[existeIndex].cantidad += cantidad;
                productosDelPedidoActual[existeIndex].subtotal = productosDelPedidoActual[existeIndex].cantidad * productosDelPedidoActual[existeIndex].precioUnitario;
            } else {
                // Agregar nuevo
                productosDelPedidoActual.push({
                    productoId: productoId,
                    idProducto: producto.idProducto,
                    nombre: producto.nombre,
                    cantidad: cantidad,
                    precioUnitario: precioUnitario,
                    subtotal: cantidad * precioUnitario,
                    componentes: producto.componentes || []
                });
            }

            // Limpiar campos
            document.getElementById('buscarProducto').value = '';
            document.getElementById('productoSelect').value = '';
            document.getElementById('cantidadProducto').value = '1';
            document.getElementById('precioUnitario').value = '';

            mostrarProductosDelPedido();
            calcularTotales();
        }

        function mostrarProductosDelPedido() {
            const container = document.getElementById('productosDelPedido');
            
            if (productosDelPedidoActual.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No hay productos agregados al pedido</p>';
                return;
            }

            let html = '<h5 style="margin-bottom: 15px;">Productos del Pedido:</h5>';
            productosDelPedidoActual.forEach((item, index) => {
                html += `
                    <div class="componente-item">
                        <div>
                            <strong>${item.idProducto}</strong> - ${item.nombre}<br>
                            <small>Cantidad: ${item.cantidad} √ó ${item.precioUnitario.toFixed(2)} = ${item.subtotal.toFixed(2)}</small>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="eliminarProductoPedido(${index})">
                            <span>üóëÔ∏è</span>
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function eliminarProductoPedido(index) {
            productosDelPedidoActual.splice(index, 1);
            mostrarProductosDelPedido();
            calcularTotales();
        }

        function togglePagoACuenta() {
            const tipoPago = document.getElementById('tipoPago').value;
            const pagoACuentaDiv = document.getElementById('pagoACuentaDiv');
            
            if (tipoPago === 'parcial') {
                pagoACuentaDiv.style.display = 'block';
                document.getElementById('pagoACuenta').required = true;
            } else {
                pagoACuentaDiv.style.display = 'none';
                document.getElementById('pagoACuenta').required = false;
                document.getElementById('pagoACuenta').value = '';
            }
            
            calcularTotales();
        }

        function calcularTotales() {
            const subtotal = productosDelPedidoActual.reduce((sum, item) => sum + item.subtotal, 0);
            const costoEnvio = parseFloat(document.getElementById('costoEnvio').value) || 0;
            const total = subtotal + costoEnvio;
            
            const tipoPago = document.getElementById('tipoPago').value;
            let pagado = 0;
            
            if (tipoPago === 'total') {
                pagado = total;
            } else if (tipoPago === 'parcial') {
                pagado = parseFloat(document.getElementById('pagoACuenta').value) || 0;
            }
            
            const saldo = total - pagado;

            document.getElementById('subtotalProductos').textContent = `${subtotal.toFixed(2)}`;
            document.getElementById('totalCostoEnvio').textContent = `${costoEnvio.toFixed(2)}`;
            document.getElementById('totalPedido').textContent = `${total.toFixed(2)}`;
            document.getElementById('totalPagado').textContent = `${pagado.toFixed(2)}`;
            document.getElementById('saldoPendiente').textContent = `${saldo.toFixed(2)}`;
        }

        async function crearPedido(event) {
            event.preventDefault();

            // Validaciones
            if (productosDelPedidoActual.length === 0) {
                mostrarAlerta('Debe agregar al menos un producto al pedido', 'warning');
                return false;
            }

            const subtotal = productosDelPedidoActual.reduce((sum, item) => sum + item.subtotal, 0);
            const costoEnvio = parseFloat(document.getElementById('costoEnvio').value) || 0;
            const total = subtotal + costoEnvio;
            const tipoPago = document.getElementById('tipoPago').value;
            const pagado = tipoPago === 'total' ? total : (parseFloat(document.getElementById('pagoACuenta').value) || 0);

            const nuevoPedido = {
                cliente: document.getElementById('clienteFinal').value.trim(),
                productos: [...productosDelPedidoActual],
                subtotal: subtotal,
                costoEnvio: costoEnvio,
                total: total,
                fechaEntrega: document.getElementById('fechaEntrega').value,
                turnoEntrega: document.getElementById('turnoEntrega').value,
                modalidadPago: document.getElementById('modalidadPago').value,
                tipoPago: tipoPago,
                montoPagado: pagado,
                saldoPendiente: total - pagado,
                estado: pagado >= total ? 'preparacion' : 'pendiente',
                fechaCreacion: new Date().toISOString(),
                activo: true
            };

            try {
                // Actualizar stock de productos
                for (const item of productosDelPedidoActual) {
                    await actualizarStockPorVenta(item.productoId, item.cantidad, item.componentes);
                }

                // Guardar pedido
                if (isOnline) {
                    const docRef = await db.collection('pedidos').add(nuevoPedido);
                    nuevoPedido.id = docRef.id;
                } else {
                    nuevoPedido.id = 'local_' + Date.now();
                    pedidos.push(nuevoPedido);
                    localStorage.setItem('pedidos', JSON.stringify(pedidos));
                }

                // Limpiar formulario
                document.getElementById('formPedido').reset();
                productosDelPedidoActual = [];
                mostrarProductosDelPedido();
                calcularTotales();
                establecerFechaHoy();

                mostrarAlerta('Pedido creado exitosamente', 'success');
                
                // Actualizar UI
                mostrarPedidos();
                actualizarDashboard();

            } catch (error) {
                console.error('Error al crear pedido:', error);
                mostrarAlerta('Error al crear pedido', 'danger');
            }

            return false;
        }

        async function actualizarStockPorVenta(productoId, cantidad, componentes) {
            const producto = productos.find(p => p.id === productoId);
            if (!producto) return;

            try {
                if (producto.tipo === 'simple') {
                    // Producto simple: restar cantidad directamente
                    const nuevoStock = producto.stock - cantidad;
                    
                    if (isOnline) {
                        await db.collection('productos').doc(productoId).update({ stock: nuevoStock });
                    } else {
                        producto.stock = nuevoStock;
                        localStorage.setItem('productos', JSON.stringify(productos));
                    }
                } else if (producto.tipo === 'compuesto' && componentes && componentes.length > 0) {
                    // Producto compuesto: restar componentes del stock
                    for (const componente of componentes) {
                        const productoComponente = productos.find(p => p.id === componente.productoId);
                        if (productoComponente) {
                            const cantidadARestar = componente.cantidad * cantidad;
                            const nuevoStockComponente = productoComponente.stock - cantidadARestar;
                            
                            if (isOnline) {
                                await db.collection('productos').doc(componente.productoId).update({ 
                                    stock: nuevoStockComponente 
                                });
                            } else {
                                productoComponente.stock = nuevoStockComponente;
                            }
                        }
                    }
                    
                    // Tambi√©n restar del stock del producto compuesto
                    const nuevoStock = producto.stock - cantidad;
                    if (isOnline) {
                        await db.collection('productos').doc(productoId).update({ stock: nuevoStock });
                    } else {
                        producto.stock = nuevoStock;
                    }
                    
                    if (!isOnline) {
                        localStorage.setItem('productos', JSON.stringify(productos));
                    }
                }
            } catch (error) {
                console.error('Error al actualizar stock:', error);
                throw error;
            }
        }

        function mostrarPedidos() {
            const lista = document.getElementById('listaPedidos');
            
            if (pedidos.length === 0) {
                lista.innerHTML = `
                    <div class="empty-state">
                        <h3>üõí No hay pedidos registrados</h3>
                        <p>Crea tu primer pedido usando el formulario de arriba</p>
                    </div>
                `;
                return;
            }

            // Filtrar solo pedidos activos (no archivados)
            const pedidosActivos = pedidos.filter(p => p.activo);
            
            if (pedidosActivos.length === 0) {
                lista.innerHTML = `
                    <div class="empty-state">
                        <h3>‚úÖ Todos los pedidos han sido completados</h3>
                        <p>Los pedidos completados se han archivado autom√°ticamente</p>
                    </div>
                `;
                return;
            }

            let html = '';
            pedidosActivos
                .sort((a, b) => new Date(a.fechaEntrega) - new Date(b.fechaEntrega))
                .forEach(pedido => {
                    const estadoBadge = {
                        'pendiente': 'estado-pendiente',
                        'preparacion': 'estado-preparacion',
                        'camino': 'estado-camino',
                        'entregado': 'estado-entregado'
                    };

                    const estadoTexto = {
                        'pendiente': 'Pendiente de Pago',
                        'preparacion': 'En Preparaci√≥n',
                        'camino': 'En Camino',
                        'entregado': 'Entregado'
                    };

                    html += `
                        <div class="pedido-card">
                            <div class="pedido-header">
                                <div>
                                    <h4>Pedido #${pedido.id.slice(-6)}</h4>
                                    <p><strong>Cliente:</strong> ${pedido.cliente}</p>
                                </div>
                                <span class="estado-pedido ${estadoBadge[pedido.estado]}">${estadoTexto[pedido.estado]}</span>
                            </div>
                            
                            <div class="pedido-info">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <h5>üìÖ Datos de Entrega</h5>
                                        <p><strong>Fecha:</strong> ${new Date(pedido.fechaEntrega).toLocaleDateString()}</p>
                                        <p><strong>Turno:</strong> ${pedido.turnoEntrega}</p>
                                    </div>
                                    <div>
                                        <h5>üí≥ Datos de Pago</h5>
                                        <p><strong>Modalidad:</strong> ${pedido.modalidadPago}</p>
                                        <p><strong>Tipo:</strong> ${pedido.tipoPago === 'total' ? 'Pago Total' : 'Pago Parcial'}</p>
                                        ${pedido.saldoPendiente > 0 ? `<p style="color: #dc3545;"><strong>Saldo Pendiente: ${pedido.saldoPendiente.toFixed(2)}</strong></p>` : '<p style="color: #28a745;"><strong>‚úÖ Pago Completo</strong></p>'}
                                    </div>
                                </div>
                            </div>

                            <div class="productos-pedido">
                                <h5>üì¶ Productos del Pedido</h5>
                                <ul>
                                    ${pedido.productos.map(p => `
                                        <li>
                                            <span><strong>${p.idProducto}</strong> - ${p.nombre}</span>
                                            <span>x${p.cantidad} - ${p.subtotal.toFixed(2)}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>

                            <div class="totales-section">
                                <div class="total-line">
                                    <span>Subtotal:</span>
                                    <span>${pedido.subtotal.toFixed(2)}</span>
                                </div>
                                <div class="total-line">
                                    <span>Env√≠o:</span>
                                    <span>${pedido.costoEnvio.toFixed(2)}</span>
                                </div>
                                <div class="total-line total-final">
                                    <span>TOTAL:</span>
                                    <span>${pedido.total.toFixed(2)}</span>
                                </div>
                            </div>

                            <div class="acciones-pedido">
                                ${pedido.estado === 'pendiente' ? `
                                    <button class="btn btn-warning" onclick="registrarPago('${pedido.id}')">
                                        <span>üí∞</span> Registrar Pago
                                    </button>
                                ` : ''}
                                ${pedido.estado === 'preparacion' ? `
                                    <button class="btn btn-info" onclick="cambiarEstadoPedido('${pedido.id}', 'camino')">
                                        <span>üöö</span> En Camino
                                    </button>
                                ` : ''}
                                ${pedido.estado === 'camino' ? `
                                    <button class="btn btn-success" onclick="cambiarEstadoPedido('${pedido.id}', 'entregado')">
                                        <span>‚úÖ</span> Entregar
                                    </button>
                                ` : ''}
                                <button class="btn btn-info btn-small" onclick="verDetallesPedido('${pedido.id}')">
                                    <span>üëÅÔ∏è</span> Detalles
                                </button>
                                <button class="btn btn-danger btn-small" onclick="eliminarPedido('${pedido.id}')">
                                    <span>üóëÔ∏è</span> Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                });
            
            lista.innerHTML = html;
        }

        function actualizarStatsPedidos() {
            const pedidosActivos = pedidos.filter(p => p.activo);
            const pedidosPendientes = pedidosActivos.filter(p => p.estado === 'pendiente' || p.saldoPendiente > 0);
            
            const hoy = new Date().toISOString().split('T')[0];
            const pedidosHoy = pedidos.filter(p => p.fechaCreacion.split('T')[0] === hoy);
            const ventasHoy = pedidosHoy.reduce((sum, p) => sum + p.montoPagado, 0);

            document.getElementById('totalPedidos').textContent = pedidosActivos.length;
            document.getElementById('pedidosPendientesCount').textContent = pedidosPendientes.length;
            document.getElementById('ventasDelDia').textContent = `${ventasHoy.toFixed(2)}`;
        }

        function filtrarPedidos() {
            const filtroEstado = document.getElementById('filtroEstado').value;
            const fechaDesde = document.getElementById('fechaDesde').value;
            const fechaHasta = document.getElementById('fechaHasta').value;
            const filtroCliente = document.getElementById('filtroCliente').value.toLowerCase();
            
            const items = document.querySelectorAll('#listaPedidos .pedido-card');
            
            items.forEach(item => {
                const pedidoId = item.querySelector('h4').textContent.replace('Pedido #', '');
                const pedido = pedidos.find(p => p.id.slice(-6) === pedidoId);
                
                if (!pedido) return;
                
                let mostrar = true;
                
                // Filtro por estado
                if (filtroEstado && pedido.estado !== filtroEstado) {
                    mostrar = false;
                }
                
                // Filtro por fechas
                if (fechaDesde && pedido.fechaEntrega < fechaDesde) {
                    mostrar = false;
                }
                if (fechaHasta && pedido.fechaEntrega > fechaHasta) {
                    mostrar = false;
                }
                
                // Filtro por cliente
                if (filtroCliente && !pedido.cliente.toLowerCase().includes(filtroCliente)) {
                    mostrar = false;
                }
                
                item.style.display = mostrar ? 'block' : 'none';
            });
        }

        async function cambiarEstadoPedido(pedidoId, nuevoEstado) {
            try {
                if (isOnline) {
                    await db.collection('pedidos').doc(pedidoId).update({ estado: nuevoEstado });
                } else {
                    const pedido = pedidos.find(p => p.id === pedidoId);
                    if (pedido) {
                        pedido.estado = nuevoEstado;
                        localStorage.setItem('pedidos', JSON.stringify(pedidos));
                    }
                }

                // Si se entrega el pedido, verificar si se debe archivar
                if (nuevoEstado === 'entregado') {
                    const pedido = pedidos.find(p => p.id === pedidoId);
                    if (pedido && pedido.saldoPendiente <= 0) {
                        // Archivar pedido (pago completo y entregado)
                        setTimeout(() => {
                            if (confirm('¬øPedido entregado y pagado completamente. ¬øArchivar pedido?')) {
                                archivarPedido(pedidoId);
                            }
                        }, 1000);
                    }
                }

                mostrarAlerta('Estado actualizado correctamente', 'success');
                mostrarPedidos();
                actualizarDashboard();

            } catch (error) {
                console.error('Error al cambiar estado:', error);
                mostrarAlerta('Error al cambiar estado', 'danger');
            }
        }

        async function archivarPedido(pedidoId) {
            try {
                if (isOnline) {
                    await db.collection('pedidos').doc(pedidoId).update({ activo: false });
                } else {
                    const pedido = pedidos.find(p => p.id === pedidoId);
                    if (pedido) {
                        pedido.activo = false;
                        localStorage.setItem('pedidos', JSON.stringify(pedidos));
                    }
                }

                mostrarAlerta('Pedido archivado correctamente', 'success');
                mostrarPedidos();
                actualizarDashboard();

            } catch (error) {
                console.error('Error al archivar pedido:', error);
                mostrarAlerta('Error al archivar pedido', 'danger');
            }
        }

        function registrarPago(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (!pedido) return;

            const contenido = `
                <div class="form-group">
                    <label><strong>Pedido:</strong> ${pedido.cliente}        <!-- PEDIDOS -->
        <div id="pedidos" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalPedidos">0</h3>
                    <p>Total Pedidos</p>
                </div>
                <div class="stat-card">
                    <h3 id="pedidosPendientesCount">0</h3>
                    <p>Pendientes</p>
                </div>
                <div class="stat-card">
                    <h3 id="ventasDelDia">$0</h3>
                    <p>Ventas del D√≠a</p>
                </div>
            </div>

            <div class="form-section">
                <h3>üõí Crear Nuevo Pedido</h3>
                <form id="formPedido" onsubmit="return crearPedido(event)">
                    <!-- Datos del Cliente -->
                    <h4 style="margin-bottom: 15px; color: #333;">üë§ Datos del Cliente</h4>
                    <div class="form-grid grid-2">
                        <div class="form-group">
                            <label>Buscar Cliente Existente</label>
                            <input type="text" id="buscarCliente" placeholder="Escriba apellido para buscar..." oninput="buscarClientesAutocomplete()">
                            <select id="clienteSelect" onchange="seleccionarCliente()" style="margin-top: 5px;">
                                <option value="">Seleccionar cliente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">Cliente Final</label>
                            <input type="text" id="clienteFinal" required placeholder="Nombre completo del cliente">
                        </div>
                    </div>

                    <!-- Productos del Pedido -->
                    <h4 style="margin: 25px 0 15px; color: #333;">üì¶ Productos del Pedido</h4>
                    <div class="form-grid grid-4">
                        <div class="form-group">
                            <label>Buscar Producto</label>
                            <input type="text" id="buscarProducto" placeholder="Escriba para buscar..." oninput="buscarProductosAutocomplete()">
                            <select id="productoSelect" onchange="seleccionarProducto()">
                                <option value="">Seleccionar producto</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">Cantidad</label>
                            <input type="number" id="cantidadProducto" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Precio Unitario</label>
                            <input type="number" id="precioUnitario" step="0.01" min="0" required>
                        </div>
                        <div style="display: flex; align-items: end;">
                            <button type="button" class="btn btn-info" onclick="agregarProductoPedido()">
                                <span>‚ûï</span> Agregar
                            </button>
                        </div>
                    </div>

                    <div id="productosDelPedido" class="productos-pedido" style="margin: 20px 0;">
                        <p style="text-align: center; color: #666;">No hay productos agregados al pedido</p>
                    </div>

                    <!-- Datos de Entrega y Pago -->
                    <div class="form-grid grid-2">
                        <div>
                            <h4 style="margin-bottom: 15px; color: #333;">üöö Datos de Entrega</h4>
                            <div class="form-group">
                                <label class="required">Fecha de Entrega</label>
                                <input type="date" id="fechaEntrega" required>
                            </div>
                            <div class="form-group">
                                <label class="required">Turno Horario</label>
                                <select id="turnoEntrega" required>
                                    <option value="">Seleccionar turno</option>
                                    <option value="ma√±ana">Ma√±ana (9:00 - 13:00)</option>
                                    <option value="tarde">Tarde (14:00 - 18:00)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Costo de Env√≠o</label>
                                <input type="number" id="costoEnvio" step="0.01" min="0" value="0" oninput="calcularTotales()">
                            </div>
                        </div>

                        <div>
                            <h4 style="margin-bottom: 15px; color: #333;">üí≥ Datos de Pago</h4>
                            <div class="form-group">
                                <label class="required">Modalidad de Pago</label>
                                <select id="modalidadPago" required>
                                    <option value="">Seleccionar modalidad</option>
                                    <option value="efectivo">Efectivo</option>
                                    <option value="transferencia">Transferencia Bancaria</option>
                                    <option value="mercadopago">MercadoPago</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="required">Tipo de Pago</label>
                                <select id="tipoPago" onchange="togglePagoACuenta()" required>
                                    <option value="">Seleccionar tipo</option>
                                    <option value="total">Pago Total</option>
                                    <option value="parcial">Pago Parcial</option>
                                </select>
                            </div>
                            <div id="pagoACuentaDiv" class="form-group" style="display: none;">
                                <label class="required">Monto Pagado a Cuenta</label>
                                <input type="number" id="pagoACuenta" step="0.01" min="0" oninput="calcularTotales()">
                            </div>
                        </div>
                    </div>

                    <!-- Totales -->
                    <div class="totales-section">
                        <div class="total-line">
                            <span><strong>Subtotal Productos:</strong></span>
                            <span id="subtotalProductos">$0.00</span>
                        </div>
                        <div class="total-line">
                            <span><strong>Costo de Env√≠o:</strong></span>
                            <span id="totalCostoEnvio">$0.00</span>
                        </div>
                        <div class="total-line total-final">
                            <span>TOTAL PEDIDO:</span>
                            <span id="totalPedido">$0.00</span>
                        </div>
                        <div class="total-line" style="color: #28a745;">
                            <span><strong>Pagado:</strong></span>
                            <span id="totalPagado">$0.00</span>
                        </div>
                        <div class="total-line" style="color: #dc3545;">
                            <span><strong>Saldo Pendiente:</strong></span>
                            <span id="saldoPendiente">$0.00</span>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 25px;">
                        <button type="submit" class="btn btn-success" style="padding: 15px 30px; font-size: 18px;">
                            <span>üõí</span> Crear Pedido
                        </button>
                    </div>
                </form>
            </div>

            <div class="search-filter-section">
                <h4>üîç Filtros de Pedidos</h4>
                <div class="filters">
                    <div class="form-group">
                        <label>Estado del Pedido</label>
                        <select id="filtroEstado" onchange="filtrarPedidos()">
                            <option value="">Todos los estados</option>
                            <option value="pendiente">Pendientes de Pago</option>
                            <option value="preparacion">En Preparaci√≥n</option>
                            <option value="camino">En Camino</option>
                            <option value="entregado">Entregados</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha Desde</label>
                        <input type="date" id="fechaDesde" onchange="filtrarPedidos()">
                    </div>
                    <div class="form-group">
                        <label>Fecha Hasta</label>
                        <input type="date" id="fechaHasta" onchange="filtrarPedidos()">
                    </div>
                    <div class="form-group">
                        <label>Cliente</label>
                        <input type="text" id="filtroCliente" placeholder="Buscar por cliente..." oninput="filtrarPedidos()">
                    </div>
                </div>
            </div>

            <div id="listaPedidos">
                <div class="loading">Cargando pedidos...</div>
            </div>
        </div>

        <!-- ESTAD√çSTICAS -->
        <div id="estadisticas" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="ventasMensuales">$0</h3>
                    <p>Ventas del Mes</p>
                </div>
                <div class="stat-card">
                    <h3 id="clientesNuevos">0</h3>
                    <p>Clientes Nuevos (mes)</p>
                </div>
                <div class="stat-card">
                    <h3 id="productosVendidos">0</h3>
                    <p>Productos Vendidos (mes)</p>
                </div>
                <div class="stat-card">
                    <h3 id="promedioVenta">$0</h3>
                    <p>Promedio por Venta</p>
                </div>
            </div>

            <div class="search-filter-section">
                <h4>üìä Configurar Reportes</h4>
                <div class="filters">
                    <div class="form-group">
                        <label>Per√≠odo</label>
                        <select id="periodoReporte" onchange="generarReporte()">
                            <option value="hoy">Hoy</option>
                            <option value="semana">Esta Semana</option>
                            <option value="mes" selected>Este Mes</option>
                            <option value="personalizado">Per√≠odo Personalizado</option>
                        </select>
                    </div>
                    <div id="fechasPersonalizadas" style="display: none;">
                        <div class="form-group">
                            <label>Desde</label>
                            <input type="date" id="reporteDesde">
                        </div>
                        <div class="form-group">
                            <label>Hasta</label>
                            <input type="date" id="reporteHasta">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Reporte</label>
                        <select id="tipoReporte" onchange="generarReporte()">
                            <option value="ventas">Reporte de Ventas</option>
                            <option value="productos">Productos M√°s Vendidos</option>
                            <option value="clientes">Clientes Frecuentes</option>
                            <option value="pagos">Formas de Pago</option>
                            <option value="zonas">Zonas de Entrega</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-info" onclick="generarReporte()">
                    <span>üìä</span> Generar Reporte
                </button>
            </div>

            <div id="reporteResultados">
                <div class="empty-state">
                    <h3>üìà Estad√≠sticas del Negocio</h3>
                    <p>Selecciona un per√≠odo y tipo de reporte para ver las estad√≠sticas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA PAGOS -->
    <div id="modalPago" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>üí∞ Registrar Pago</h4>
                <button class="close-modal" onclick="cerrarModal('modalPago')">&times;</button>
            </div>
            <div id="contenidoModalPago">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>

    <!-- MODAL PARA DETALLES -->
    <div id="modalDetalle" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>üìã Detalles del Pedido</h4>
                <button class="close-modal" onclick="cerrarModal('modalDetalle')">&times;</button>
            </div>
            <div id="contenidoModalDetalle">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBH8qF7QhKqJ4VQ_Qd6zGHgKtY3Wy5N4A8",
            authDomain: "sistema-pastrami.firebaseapp.com",
            projectId: "sistema-pastrami",
            storageBucket: "sistema-pastrami.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abc123def456ghi789"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variables globales
        let clientes = [];
        let productos = [];
        let pedidos = [];
        let componentesTemporales = [];
        let productosDelPedidoActual = [];
        let isOnline = false;

        // Funci√≥n para mostrar/ocultar tabs
        function showTab(tabName) {
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remover clase active de todos los tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar contenido seleccionado
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Cargar datos espec√≠ficos del tab
            switch(tabName) {
                case 'dashboard':
                    cargarDashboard();
                    break;
                case 'clientes':
                    cargarClientes();
                    break;
                case 'productos':
                    cargarProductos();
                    break;
                case 'pedidos':
                    cargarPedidos();
                    break;
                case 'estadisticas':
                    cargarEstadisticas();
                    break;
            }
        }

        // Funci√≥n para inicializar la aplicaci√≥n
        async function inicializarApp() {
            try {
                // Verificar conexi√≥n con Firebase
                await db.collection('test').limit(1).get();
                isOnline = true;
                actualizarEstadoConexion(true);
                
                // Cargar datos iniciales
                await cargarTodosLosDatos();
                
                // Configurar listeners en tiempo real
                configurarListenersTempoReal();
                
                // Cargar dashboard inicial
                cargarDashboard();
                
            } catch (error) {
                console.error('Error al conectar con Firebase:', error);
                isOnline = false;
                actualizarEstadoConexion(false);
                
                // Cargar datos desde localStorage como fallback
                cargarDatosLocal();
                cargarDashboard();
            }
        }

        // Funci√≥n para actualizar estado de conexi√≥n
        function actualizarEstadoConexion(online) {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            
            if (online) {
                syncStatus.className = 'sync-status sync-online';
                syncText.textContent = 'üü¢ Conectado';
            } else {
                syncStatus.className = 'sync-status sync-offline';
                syncText.textContent = 'üî¥ Sin conexi√≥n';
            }
        }

        // Funci√≥n para cargar todos los datos desde Firebase
        async function cargarTodosLosDatos() {
            try {
                // Cargar clientes
                const clientesSnapshot = await db.collection('clientes').get();
                clientes = clientesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Cargar productos
                const productosSnapshot = await db.collection('productos').get();
                productos = productosSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Cargar pedidos
                const pedidosSnapshot = await db.collection('pedidos').get();
                pedidos = pedidosSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Guardar en localStorage como backup
                localStorage.setItem('clientes', JSON.stringify(clientes));
                localStorage.setItem('productos', JSON.stringify(productos));
                localStorage.setItem('pedidos', JSON.stringify(pedidos));

            } catch (error) {
                console.error('Error al cargar datos:', error);
                throw error;
            }
        }

        // Funci√≥n para cargar datos desde localStorage
        function cargarDatosLocal() {
            clientes = JSON.parse(localStorage.getItem('clientes')) || [];
            productos = JSON.parse(localStorage.getItem('productos')) || [];
            pedidos = JSON.parse(localStorage.getItem('pedidos')) || [];
        }

        // Funci√≥n para configurar listeners en tiempo real
        function configurarListenersTempoReal() {
            if (!isOnline) return;

            // Listener para clientes
            db.collection('clientes').onSnapshot((snapshot) => {
                clientes = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                localStorage.setItem('clientes', JSON.stringify(clientes));
                
                // Actualizar UI si estamos en la tab de clientes
                if (document.getElementById('clientes').classList.contains('active')) {
                    mostrarClientes();
                }
                actualizarDashboard();
            });

            // Listener para productos
            db.collection('productos').onSnapshot((snapshot) => {
                productos = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                localStorage.setItem('productos', JSON.stringify(productos));
                
                // Actualizar UI si estamos en la tab de productos
                if (document.getElementById('productos').classList.contains('active')) {
                    mostrarProductos();
                }
                actualizarDashboard();
            });

            // Listener para pedidos
            db.collection('pedidos').onSnapshot((snapshot) => {
                pedidos = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                localStorage.setItem('pedidos', JSON.stringify(pedidos));
                
                // Actualizar UI si estamos en la tab de pedidos
                if (document.getElementById('pedidos').classList.contains('active')) {
                    mostrarPedidos();
                }
                actualizarDashboard();
            });
        }

        // FUNCIONES DE CLIENTES
        async function agregarCliente(event) {
            event.preventDefault();
            
            const nuevoCliente = {
                nombre: document.getElementById('nombreCliente').value.trim(),
                apellido: document.getElementById('apellidoCliente').value.trim(),
                telefono: document.getElementById('telefonoCliente').value.trim(),
                email: document.getElementById('emailCliente').value.trim(),
                calle: document.getElementById('calleCliente').value.trim(),
                numero: document.getElementById('numeroCliente').value.trim(),
                piso: document.getElementById('pisoCliente').value.trim(),
                codigoPostal: document.getElementById('codigoPostalCliente').value.trim(),
                localidad: document.getElementById('localidadCliente').value.trim(),
                fechaRegistro: new Date().toISOString(),
                activo: true
            };

            // Validar campos requeridos
            if (!nuevoCliente.nombre || !nuevoCliente.apellido || !nuevoCliente.telefono) {
                mostrarAlerta('Por favor completa todos los campos obligatorios', 'warning');
                return false;
            }

            try {
                if (isOnline) {
                    // Guardar en Firebase
                    const docRef = await db.collection('clientes').add(nuevoCliente);
                    nuevoCliente.id = docRef.id;
                } else {
                    // Guardar localmente
                    nuevoCliente.id = 'local_' + Date.now();
                    clientes.push(nuevoCliente);
                    localStorage.setItem('clientes', JSON.stringify(clientes));
                }

                // Limpiar formulario
                document.getElementById('formCliente').reset();
                
                mostrarAlerta('Cliente agregado exitosamente', 'success');
                
                // Actualizar UI
                mostrarClientes();
                actualizarDashboard();

            } catch (error) {
                console.error('Error al agregar cliente:', error);
                mostrarAlerta('Error al agregar cliente', 'danger');
            }

            return false;
        }

        function cargarClientes() {
            mostrarClientes();
            actualizarStatsClientes();
        }

        function mostrarClientes() {
            const lista = document.getElementById('listaClientes');
            
            if (clientes.length === 0) {
                lista.innerHTML = `
                    <div class="empty-state">
                        <h3>üë• No hay clientes registrados</h3>
                        <p>Agrega tu primer cliente usando el formulario de arriba</p>
                    </div>
                `;
                return;
            }

            let html = '';
            clientes.forEach(cliente => {
                const direccionCompleta = [
                    cliente.calle,
                    cliente.numero,
                    cliente.piso,
                    cliente.localidad,
                    cliente.codigoPostal ? `(${cliente.codigoPostal})` : ''
                ].filter(Boolean).join(' ');

                html += `
                    <div class="item-card">
                        <div class="item-header">
                            <div class="item-info">
                                <h4>${cliente.nombre} ${cliente.apellido}</h4>
                                <p><strong>üìû</strong> ${cliente.telefono}</p>
                                ${cliente.email ? `<p><strong>üìß</strong> ${cliente.email}</p>` : ''}
                                ${direccionCompleta ? `<p><strong>üìç</strong> ${direccionCompleta}</p>` : ''}
                                <p><strong>üìÖ</strong> Registrado: ${new Date(cliente.fechaRegistro).toLocaleDateString()}</p>
                            </div>
                            <div class="item-actions">
                                <button class="btn btn-warning btn-small" onclick="editarCliente('${cliente.id}')">
                                    <span>‚úèÔ∏è</span> Editar
                                </button>
                                <button class="btn ${cliente.activo ? 'btn-danger' : 'btn-success'} btn-small" onclick="toggleClienteActivo('${cliente.id}')">
                                    <span>${cliente.activo ? '‚ùå' : '‚úÖ'}</span> ${cliente.activo ? 'Desactivar' : 'Activar'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            lista.innerHTML = html;
        }

        function actualizarStatsClientes() {
            const clientesActivos = clientes.filter(c => c.activo).length;
            document.getElementById('totalClientesTab').textContent = clientes.length;
            document.getElementById('clientesActivos').textContent = clientesActivos;
        }

        function filtrarClientes() {
            const filtro = document.getElementById('searchClientes').value.toLowerCase();
            const items = document.querySelectorAll('#listaClientes .item-card');
            
            items.forEach(item => {
                const texto = item.textContent.toLowerCase();
                item.style.display = texto.includes(filtro) ? 'block' : 'none';
            });
        }

        // FUNCIONES DE PRODUCTOS
        function toggleComponentes() {
            const tipo = document.getElementById('tipoProducto').value;
            const section = document.getElementById('componentesSection');
            
            if (tipo === 'compuesto') {
                section.style.display = 'block';
                cargarProductosEnComponentes();
            } else {
                section.style.display = 'none';
                componentesTemporales = [];
            }
        }

        function cargarProductosEnComponentes() {
            const select = document.getElementById('productoComponente');
            select.innerHTML = '<option value="">Seleccionar producto</option>';
            
            productos.filter(p => p.tipo === 'simple').forEach(producto => {
                select.innerHTML += `<option value="${producto.id}">${producto.idProducto} - ${producto.nombre}</option>`;
            });
        }

        function agregarComponente() {
            const productoId = document.getElementById('productoComponente').value;
            const cantidad = parseInt(document.getElementById('cantidadComponente').value);

            if (!productoId || !cantidad) {
                mostrarAlerta('Selecciona un producto y cantidad', 'warning');
                return;
            }

            const producto = productos.find(p => p.id === productoId);
            if (!producto) return;

            // Verificar si ya existe
            const existeIndex = componentesTemporales.findIndex(c => c.productoId === productoId);
            if (existeIndex !== -1) {
                componentesTemporales[existeIndex].cantidad += cantidad;
            } else {
                componentesTemporales.push({
                    productoId: productoId,
                    idProducto: producto.idProducto,
                    nombre: producto.nombre,
                    cantidad: cantidad
                });
            }

            mostrarComponentes();
            document.getElementById('productoComponente').value = '';
            document.getElementById('cantidadComponente').value = '1';
        }

        function mostrarComponentes() {
            const lista = document.getElementById('listaComponentes');
            
            if (componentesTemporales.length === 0) {
                lista.innerHTML = '<p style="text-align: center; color: #666;">No hay componentes agregados</p>';
                return;
            }

            let html = '';
            componentesTemporales.forEach((comp, index) => {
                html += `
                    <div class="componente-item">
                        <span><strong>${comp.idProducto}</strong> - ${comp.nombre} <span class="badge badge-info">x${comp.cantidad}</span></span>
                        <button class="btn btn-danger btn-small" onclick="eliminarComponente(${index})">
                            <span>üóëÔ∏è</span> Quitar
                        </button>
                    </div>
                `;
            });
            lista.innerHTML = html;
        }

        function eliminarComponente(index) {
            componentesTemporales.splice(index, 1);
            mostrarComponentes();
        }

        async function agregarProducto(event) {
            event.preventDefault();

            const nuevoProducto = {
                idProducto: document.getElementById('idProducto').value.trim().toUpperCase(),
                nombre: document.getElementById('nombreProducto').value.trim(),
                stock: parseInt(document.getElementById('stockProducto').value),
                precioSugerido: parseFloat(document.getElementById('precioProducto').value) || 0,
                tipo: document.getElementById('tipoProducto').value,
                componentes: [...componentesTemporales],
                fechaCreacion: new Date().toISOString(),
                activo: true
            };

            // Validaciones
            if (!nuevoProducto.idProducto || !nuevoProducto.nombre || nuevoProducto.stock < 0 || !nuevoProducto.tipo) {
                mostrarAlerta('Por favor completa todos los campos obligatorios', 'warning');
                return false;
            }

            // Verificar ID √∫nico
            if (productos.some(p => p.idProducto === nuevoProducto.idProducto)) {
                mostrarAlerta('Ya existe un producto con ese ID', 'warning');
                return false;
            }

            // Validar componentes para productos compuestos
            if (nuevoProducto.tipo === 'compuesto' && componentesTemporales.length === 0) {
                mostrarAlerta('Los productos compuestos deben tener al menos un componente', 'warning');
                return false;
            }

            try {
                if (isOnline) {
                    const docRef = await db.collection('productos').add(nuevoProducto);
                    nuevoProducto.id = docRef.id;
                } else {
                    nuevoProducto.id = 'local_' + Date.now();
                    productos.push(nuevoProducto);
                    localStorage.setItem('productos', JSON.stringify(productos));
                }

                // Limpiar formulario
                document.getElementById('formProducto').reset();
                componentesTemporales = [];
                document.getElementById('componentesSection').style.display = 'none';
                document.getElementById('listaComponentes').innerHTML = '<p style="text-align: center; color: #666;">No hay componentes agregados</p>';
                
                mostrarAlerta('Producto agregado exitosamente', 'success');
                
                // Actualizar UI
                mostrarProductos();
                actualizarDashboard();

            } catch (error) {
                console.error('Error al agregar producto:', error);
                mostrarAlerta('Error al agregar producto', 'danger');
            }

            return false;
        }

        function cargarProductos() {<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Pastrami - Gesti√≥n Completa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .sync-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 14px;
        }

        .sync-online { background: rgba(76, 175, 80, 0.3); }
        .sync-offline { background: rgba(244, 67, 54, 0.3); }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            color: #007bff;
            background: white;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #007bff;
        }

        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #007bff;
        }

        .form-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 15px;
        }

        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .grid-4 { grid-template-columns: 1fr 1fr 1fr auto; }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .required::after {
            content: ' *';
            color: #dc3545;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success { background: linear-gradient(45deg, #28a745, #1e7e34); }
        .btn-danger { background: linear-gradient(45deg, #dc3545, #c82333); }
        .btn-warning { background: linear-gradient(45deg, #ffc107, #e0a800); color: #000; }
        .btn-info { background: linear-gradient(45deg, #17a2b8, #138496); }
        .btn-small { padding: 8px 16px; font-size: 14px; }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .stat-card p {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 500;
        }

        .item-card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            position: relative;
        }

        .item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .item-info h4 {
            color: #333;
            margin-bottom: 8px;
            font-size: 1.2em;
        }

        .item-info p {
            color: #666;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .item-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .badge-primary { background: #cce5ff; color: #004085; }

        .componentes-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e9ecef;
        }

        .componente-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .componente-item:last-child {
            margin-bottom: 0;
        }

        .search-filter-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #e1e8ed;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box input {
            padding-left: 45px;
            font-size: 16px;
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            z-index: 1;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .pedido-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 5px solid #007bff;
            transition: all 0.3s ease;
        }

        .pedido-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .pedido-info {
            margin-bottom: 20px;
        }

        .pedido-info h5 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .productos-pedido {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .productos-pedido ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .productos-pedido li {
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .productos-pedido li:last-child {
            border-bottom: none;
        }

        .totales-section {
            background: linear-gradient(45deg, #f8f9fa, #ffffff);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .total-final {
            font-size: 1.4em;
            font-weight: 700;
            color: #007bff;
            border-top: 2px solid #007bff;
            padding-top: 15px;
            margin-top: 15px;
        }

        .estado-pedido {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .estado-pendiente { background: #fff3cd; color: #856404; }
        .estado-preparacion { background: #cce5ff; color: #004085; }
        .estado-camino { background: #d4edda; color: #155724; }
        .estado-entregado { background: #d1ecf1; color: #0c5460; }

        .acciones-pedido {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #495057;
        }

        .empty-state p {
            font-size: 1.1em;
            opacity: 0.8;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            font-size: 1.1em;
            color: #6c757d;
        }

        .loading::before {
            content: '‚è≥';
            margin-right: 10px;
            font-size: 1.5em;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: #28a745;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-header h4 {
            color: #333;
            font-size: 1.3em;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                border-radius: 10px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .sync-status {
                position: static;
                margin-top: 10px;
                display: inline-block;
            }
            
            .tab {
                padding: 12px 8px;
                font-size: 12px;
                min-width: 80px;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            .form-grid {
                grid-template-columns: 1fr !important;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card h3 {
                font-size: 2em;
            }
            
            .item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .item-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
            
            .pedido-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .acciones-pedido {
                flex-direction: column;
            }
            
            .modal-content {
                margin: 20px;
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .tab {
                font-size: 11px;
                padding: 10px 5px;
            }
            
            .form-section {
                padding: 15px;
            }
            
            .item-card {
                padding: 15px;
            }
            
            .pedido-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü•™ Sistema Pastrami</h1>
            <p>Gesti√≥n completa de tu emprendimiento</p>
            <div id="syncStatus" class="sync-status sync-offline">
                <span id="syncText">Conectando...</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('clientes')">üë• Clientes</button>
            <button class="tab" onclick="showTab('productos')">üì¶ Productos</button>
            <button class="tab" onclick="showTab('pedidos')">üõí Pedidos</button>
            <button class="tab" onclick="showTab('estadisticas')">üìà Estad√≠sticas</button>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboard" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalClientes">0</h3>
                    <p>Total Clientes</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalProductos">0</h3>
                    <p>Total Productos</p>
                </div>
                <div class="stat-card">
                    <h3 id="pedidosHoy">0</h3>
                    <p>Pedidos Hoy</p>
                </div>
                <div class="stat-card">
                    <h3 id="ventasHoy">$0</h3>
                    <p>Ventas Hoy</p>
                </div>
            </div>

            <div class="item-card">
                <h4>üö® Resumen de Actividades</h4>
                <div id="resumenActividades">
                    <div class="loading">Cargando resumen...</div>
                </div>
            </div>

            <div class="item-card">
                <h4>üìã Pedidos Pendientes de Entrega</h4>
                <div id="pedidosPendientes">
                    <div class="loading">Cargando pedidos...</div>
                </div>
            </div>
        </div>

        <!-- CLIENTES -->
        <div id="clientes" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalClientesTab">0</h3>
                    <p>Total Clientes</p>
                </div>
                <div class="stat-card">
                    <h3 id="clientesActivos">0</h3>
                    <p>Clientes Activos</p>
                </div>
            </div>

            <div class="form-section">
                <h3>‚ûï Agregar Nuevo Cliente</h3>
                <form id="formCliente" onsubmit="return agregarCliente(event)">
                    <div class="form-grid grid-3">
                        <div class="form-group">
                            <label class="required">Nombre</label>
                            <input type="text" id="nombreCliente" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Apellido</label>
                            <input type="text" id="apellidoCliente" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Tel√©fono</label>
                            <input type="tel" id="telefonoCliente" required>
                        </div>
                    </div>

                    <div class="form-grid grid-5">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="emailCliente">
                        </div>
                        <div class="form-group">
                            <label>Calle</label>
                            <input type="text" id="calleCliente">
                        </div>
                        <div class="form-group">
                            <label>N√∫mero</label>
                            <input type="text" id="numeroCliente">
                        </div>
                        <div class="form-group">
                            <label>Piso/Depto</label>
                            <input type="text" id="pisoCliente">
                        </div>
                        <div class="form-group">
                            <label>C√≥digo Postal</label>
                            <input type="text" id="codigoPostalCliente">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Localidad</label>
                        <input type="text" id="localidadCliente">
                    </div>

                    <button type="submit" class="btn btn-success">
                        <span>‚ûï</span> Agregar Cliente
                    </button>
                </form>
            </div>

            <div class="search-filter-section">
                <div class="search-box">
                    <input type="text" id="searchClientes" placeholder="Buscar clientes por nombre, apellido o tel√©fono..." oninput="filtrarClientes()">
                </div>
            </div>

            <div id="listaClientes">
                <div class="loading">Cargando clientes...</div>
            </div>
        </div>

        <!-- PRODUCTOS -->
        <div id="productos" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalProductosTab">0</h3>
                    <p>Total Productos</p>
                </div>
                <div class="stat-card">
                    <h3 id="valorInventario">$0</h3>
                    <p>Valor Inventario</p>
                </div>
            </div>

            <div class="form-section">
                <h3>‚ûï Agregar Nuevo Producto</h3>
                <form id="formProducto" onsubmit="return agregarProducto(event)">
                    <div class="form-grid grid-4">
                        <div class="form-group">
                            <label class="required">ID del Producto</label>
                            <input type="text" id="idProducto" required placeholder="Ej: P001">
                        </div>
                        <div class="form-group">
                            <label class="required">Nombre del Producto</label>
                            <input type="text" id="nombreProducto" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Stock Inicial</label>
                            <input type="number" id="stockProducto" required min="0">
                        </div>
                        <div class="form-group">
                            <label>Precio Sugerido</label>
                            <input type="number" id="precioProducto" step="0.01" min="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="required">Tipo de Producto</label>
                        <select id="tipoProducto" onchange="toggleComponentes()" required>
                            <option value="">Seleccionar tipo</option>
                            <option value="simple">Producto Simple</option>
                            <option value="compuesto">Producto Compuesto (Caja/Pack)</option>
                        </select>
                    </div>

                    <div id="componentesSection" style="display: none;">
                        <h4>üîß Componentes del Producto</h4>
                        <p style="color: #666; margin-bottom: 15px;">Define qu√© productos se restan del stock cuando se vende este item compuesto</p>
                        
                        <div class="form-grid grid-3">
                            <div class="form-group">
                                <label>Producto Component</label>
                                <select id="productoComponente">
                                    <option value="">Seleccionar producto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Cantidad que se resta</label>
                                <input type="number" id="cantidadComponente" min="1" value="1">
                            </div>
                            <div style="display: flex; align-items: end;">
                                <button type="button" class="btn btn-info" onclick="agregarComponente()">
                                    <span>‚ûï</span> Agregar
                                </button>
                            </div>
                        </div>

                        <div id="listaComponentes" class="componentes-list">
                            <p style="text-align: center; color: #666;">No hay componentes agregados</p>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success">
                        <span>‚ûï</span> Agregar Producto
                    </button>
                </form>
            </div>

            <div class="search-filter-section">
                <div class="search-box">
                    <input type="text" id="searchProductos" placeholder="Buscar productos por ID o nombre..." oninput="filtrarProductos()">
                </div>
                <div class="filters">
                    <div class="form-group">
                        <label>Filtrar por tipo</label>
                        <select id="filtroTipoProducto" onchange="filtrarProductos()">
                            <option value="">Todos los tipos</option>
                            <option value="simple">Productos Simples</option>
                            <option value="compuesto">Productos Compuestos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Filtrar por stock</label>
                        <select id="filtroStock" onchange="filtrarProductos()">
                            <option value="">Todo el stock</option>
                            <option value="bajo">Stock bajo (‚â§5)</option>
                            <option value="sin">Sin stock (0)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="listaProductos">
                <div class="loading">Cargando productos...</div>
            </div>
        </div>

        <!-- PEDIDOS -->
        <div id="pedidos" class="tab-content">
            <div
