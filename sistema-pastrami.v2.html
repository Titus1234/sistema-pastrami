<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Pastrami - Gesti칩n Completa</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .nav-tab {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            transform: scale(1.05);
        }

        .section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .section.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
        }

        .table th {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            color: white;
            font-weight: 600;
        }

        .table tr:hover {
            background-color: #f8f9fa;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
        }

        .card-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pendiente {
            background: #fff3cd;
            color: #856404;
        }

        .status-pagado {
            background: #d1edff;
            color: #0c5460;
        }

        .status-entregado {
            background: #d4edda;
            color: #155724;
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e1e8ed;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
        }

        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                width: 100%;
                margin-bottom: 10px;
            }

            .form-row {
                flex-direction: column;
            }

            .table {
                font-size: 14px;
            }

            .table th,
            .table td {
                padding: 8px;
            }
        }

        .product-components {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .component-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .component-row input {
            flex: 1;
        }

        .component-row button {
            padding: 8px 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>游볽 Sistema Pastrami</h1>
            <p>Gesti칩n Completa del Emprendimiento</p>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showSection('dashboard')">Dashboard</button>
                <button class="nav-tab" onclick="showSection('clientes')">Clientes</button>
                <button class="nav-tab" onclick="showSection('productos')">Productos</button>
                <button class="nav-tab" onclick="showSection('pedidos')">Nuevo Pedido</button>
                <button class="nav-tab" onclick="showSection('lista_pedidos')">Lista Pedidos</button>
                <button class="nav-tab" onclick="showSection('pagos')">Pagos</button>
                <button class="nav-tab" onclick="showSection('estadisticas')">Estad칤sticas</button>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-clientes">0</div>
                    <div class="stat-label">Total Clientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-productos">0</div>
                    <div class="stat-label">Total Productos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pedidos-pendientes">0</div>
                    <div class="stat-label">Pedidos Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="ingresos-mes">$0</div>
                    <div class="stat-label">Ingresos del Mes</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Pr칩ximas Entregas</div>
                <div id="proximas-entregas"></div>
            </div>

            <div class="card">
                <div class="card-header">Productos con Stock Bajo</div>
                <div id="stock-bajo"></div>
            </div>
        </div>

        <!-- Clientes Section -->
        <div id="clientes" class="section">
            <div class="card">
                <div class="card-header">Registro de Clientes</div>
                <form id="form-cliente">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre *</label>
                            <input type="text" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Apellido *</label>
                            <input type="text" name="apellido" required>
                        </div>
                        <div class="form-group">
                            <label>Tel칠fono *</label>
                            <input type="tel" name="telefono" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Calle</label>
                            <input type="text" name="calle">
                        </div>
                        <div class="form-group">
                            <label>N칰mero</label>
                            <input type="text" name="numero">
                        </div>
                        <div class="form-group">
                            <label>Piso/Depto</label>
                            <input type="text" name="piso">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>C칩digo Postal</label>
                            <input type="text" name="codigo_postal">
                        </div>
                        <div class="form-group">
                            <label>Localidad</label>
                            <input type="text" name="localidad">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="email">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">Registrar Cliente</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">Lista de Clientes</div>
                <table class="table" id="tabla-clientes">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Apellido</th>
                            <th>Tel칠fono</th>
                            <th>Direcci칩n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Productos Section -->
        <div id="productos" class="section">
            <div class="card">
                <div class="card-header">Registro de Productos</div>
                <form id="form-producto">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ID del Producto *</label>
                            <input type="text" name="id" required>
                        </div>
                        <div class="form-group">
                            <label>Nombre del Producto *</label>
                            <input type="text" name="nombre" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Precio *</label>
                            <input type="number" name="precio" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Stock Inicial *</label>
                            <input type="number" name="stock_inicial" required>
                        </div>
                        <div class="form-group">
                            <label>Stock M칤nimo *</label>
                            <input type="number" name="stock_minimo" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Unidad de Medida</label>
                            <select name="unidad">
                                <option value="unidades">Unidades</option>
                                <option value="kg">Kilogramos</option>
                                <option value="g">Gramos</option>
                                <option value="cajas">Cajas</option>
                                <option value="porciones">Porciones</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>쮼s producto compuesto?</label>
                            <select name="es_compuesto" onchange="toggleComponentes(this)">
                                <option value="no">No</option>
                                <option value="si">S칤</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="componentes-container" class="product-components" style="display: none;">
                        <h4>Componentes del Producto</h4>
                        <div id="componentes-list"></div>
                        <button type="button" class="btn" onclick="agregarComponente()">Agregar Componente</button>
                    </div>

                    <button type="submit" class="btn btn-success">Registrar Producto</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">Lista de Productos</div>
                <table class="table" id="tabla-productos">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Precio</th>
                            <th>Stock Actual</th>
                            <th>Stock M칤nimo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Nuevo Pedido Section -->
        <div id="pedidos" class="section">
            <div class="card">
                <div class="card-header">Nuevo Pedido</div>
                <form id="form-pedido">
                    <div class="form-row">
                        <div class="form-group autocomplete-container">
                            <label>Cliente *</label>
                            <input type="text" name="cliente_buscar" id="cliente-buscar" placeholder="Buscar por apellido..." autocomplete="off">
                            <div class="autocomplete-list" id="cliente-list"></div>
                            <input type="hidden" name="cliente_id" id="cliente-id">
                        </div>
                        <div class="form-group">
                            <label>Fecha de Entrega *</label>
                            <input type="date" name="fecha_entrega" required>
                        </div>
                        <div class="form-group">
                            <label>Turno de Entrega</label>
                            <select name="turno_entrega">
                                <option value="ma침ana">Ma침ana</option>
                                <option value="tarde">Tarde</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Costo de Env칤o</label>
                            <input type="number" name="costo_envio" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Forma de Pago</label>
                            <select name="forma_pago">
                                <option value="efectivo">Efectivo</option>
                                <option value="transferencia">Transferencia Bancaria</option>
                                <option value="mercadopago">MercadoPago</option>
                            </select>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Productos del Pedido</div>
                        <div id="productos-pedido">
                            <div class="product-row">
                                <div class="form-row">
                                    <div class="form-group autocomplete-container">
                                        <label>Producto</label>
                                        <input type="text" class="producto-buscar" placeholder="Buscar producto..." autocomplete="off">
                                        <div class="autocomplete-list producto-list"></div>
                                        <input type="hidden" class="producto-id">
                                    </div>
                                    <div class="form-group">
                                        <label>Cantidad</label>
                                        <input type="number" class="producto-cantidad" min="1" value="1">
                                    </div>
                                    <div class="form-group">
                                        <label>Precio Unitario</label>
                                        <input type="number" class="producto-precio" step="0.01" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label>Subtotal</label>
                                        <input type="number" class="producto-subtotal" step="0.01" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label>&nbsp;</label>
                                        <button type="button" class="btn btn-danger" onclick="eliminarProductoPedido(this)">Eliminar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn" onclick="agregarProductoPedido()">Agregar Producto</button>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Total de la Compra</label>
                            <input type="number" name="total_compra" id="total-compra" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                            <label>Monto Pagado</label>
                            <input type="number" name="monto_pagado" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Saldo Pendiente</label>
                            <input type="number" name="saldo_pendiente" id="saldo-pendiente" step="0.01" readonly>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success">Crear Pedido</button>
                </form>
            </div>
        </div>

        <!-- Lista Pedidos Section -->
        <div id="lista_pedidos" class="section">
            <div class="card">
                <div class="card-header">Lista de Pedidos Activos</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Filtrar por Estado</label>
                        <select id="filtro-estado" onchange="filtrarPedidos()">
                            <option value="todos">Todos</option>
                            <option value="pendiente_entrega">Pendientes de Entrega</option>
                            <option value="pendiente_pago">Pendientes de Pago</option>
                            <option value="completados">Completados</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ordenar por</label>
                        <select id="orden-pedidos" onchange="ordenarPedidos()">
                            <option value="fecha_entrega">Fecha de Entrega</option>
                            <option value="fecha_pedido">Fecha de Pedido</option>
                            <option value="cliente">Cliente</option>
                            <option value="total">Total</option>
                        </select>
                    </div>
                </div>
                <div id="lista-pedidos-container"></div>
            </div>
        </div>

        <!-- Pagos Section -->
        <div id="pagos" class="section">
            <div class="card">
                <div class="card-header">Gesti칩n de Pagos</div>
                <div id="pedidos-con-saldo"></div>
            </div>
        </div>

        <!-- Estad칤sticas Section -->
        <div id="estadisticas" class="section">
            <div class="card">
                <div class="card-header">Estad칤sticas y Reportes</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Desde</label>
                        <input type="date" id="fecha-desde">
                    </div>
                    <div class="form-group">
                        <label>Hasta</label>
                        <input type="date" id="fecha-hasta">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn" onclick="generarEstadisticas()">Generar Reporte</button>
                    </div>
                </div>

                <div class="stats-grid" id="estadisticas-grid"></div>
                
                <div id="reportes-detallados"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci칩n de Firebase
        const firebaseConfig = {
            apiKey: "demo-key",
            authDomain: "pastrami-sistema.firebaseapp.com",
            projectId: "pastrami-sistema",
            storageBucket: "pastrami-sistema.appspot.com",
            messagingSenderId: "123456789",
            appId: "demo-app-id"
        };

        // Inicializar Firebase (simulado para demo)
        let db = {
            collection: (name) => ({
                add: (data) => Promise.resolve({id: Date.now().toString()}),
                get: () => Promise.resolve({docs: []}),
                doc: (id) => ({
                    update: (data) => Promise.resolve(),
                    delete: () => Promise.resolve(),
                    get: () => Promise.resolve({data: () => ({}), exists: true})
                }),
                where: (field, op, value) => ({
                    get: () => Promise.resolve({docs: []})
                }),
                orderBy: (field, direction) => ({
                    get: () => Promise.resolve({docs: []})
                })
            })
        };

        // Datos en memoria para demo
        let clientes = [];
        let productos = [];
        let pedidos = [];
        let pagos = [];
        let nextClienteId = 1;
        let nextPedidoId = 1;

        // Funciones de navegaci칩n
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            
            if (sectionId === 'dashboard') {
                actualizarDashboard();
            } else if (sectionId === 'lista_pedidos') {
                cargarListaPedidos();
            } else if (sectionId === 'pagos') {
                cargarPedidosConSaldo();
            }
        }

        // Gesti칩n de Clientes
        document.getElementById('form-cliente').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const cliente = {
                id: nextClienteId++,
                nombre: formData.get('nombre'),
                apellido: formData.get('apellido'),
                telefono: formData.get('telefono'),
                direccion: {
                    calle: formData.get('calle') || '',
                    numero: formData.get('numero') || '',
                    piso: formData.get('piso') || '',
                    codigo_postal: formData.get('codigo_postal') || '',
                    localidad: formData.get('localidad') || ''
                },
                email: formData.get('email') || '',
                fecha_registro: new Date().toISOString()
            };
            
            clientes.push(cliente);
            actualizarTablaClientes();
            e.target.reset();
            mostrarAlerta('Cliente registrado exitosamente', 'success');
        });

        function actualizarTablaClientes() {
            const tbody = document.querySelector('#tabla-clientes tbody');
            tbody.innerHTML = '';
            
            clientes.forEach(cliente => {
                const direccion = `${cliente.direccion.calle} ${cliente.direccion.numero}, ${cliente.direccion.localidad}`.trim();
                const row = `
                    <tr>
                        <td>${cliente.id}</td>
                        <td>${cliente.nombre}</td>
                        <td>${cliente.apellido}</td>
                        <td>${cliente.telefono}</td>
                        <td>${direccion}</td>
                        <td>
                            <button class="btn btn-warning" onclick="editarCliente(${cliente.id})">Editar</button>
                            <button class="btn btn-danger" onclick="eliminarCliente(${cliente.id})">Eliminar</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function eliminarCliente(id) {
            if (confirm('쮼st치 seguro de eliminar este cliente?')) {
                clientes = clientes.filter(c => c.id !== id);
                actualizarTablaClientes();
                mostrarAlerta('Cliente eliminado exitosamente', 'success');
            }
        }

        // Gesti칩n de Productos
        function toggleComponentes(select) {
            const container = document.getElementById('componentes-container');
            if (select.value === 'si') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        function agregarComponente() {
            const container = document.getElementById('componentes-list');
            const componenteId = Date.now();
            const componenteHtml = `
                <div class="component-row" id="componente-${componenteId}">
                    <input type="text" placeholder="Producto componente" class="componente-producto">
                    <input type="number" placeholder="Cantidad" class="componente-cantidad" min="1" value="1">
                    <button type="button" class="btn btn-danger" onclick="eliminarComponente(${componenteId})">Eliminar</button>
                </div>
            `;
            container.innerHTML += componenteHtml;
        }

        function eliminarComponente(id) {
            document.getElementById(`componente-${id}`).remove();
        }

        document.getElementById('form-producto').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            // Verificar si el ID ya existe
            if (productos.find(p => p.id === formData.get('id'))) {
                mostrarAlerta('El ID del producto ya existe', 'error');
                return;
            }
            
            const producto = {
                id: formData.get('id'),
                nombre: formData.get('nombre'),
                precio: parseFloat(formData.get('precio')),
                stock_inicial: parseInt(formData.get('stock_inicial')),
                stock_actual: parseInt(formData.get('stock_inicial')),
                stock_minimo: parseInt(formData.get('stock_minimo')),
                unidad: formData.get('unidad'),
                es_compuesto: formData.get('es_compuesto') === 'si',
                componentes: [],
                fecha_registro: new Date().toISOString()
            };
            
            // Si es producto compuesto, agregar componentes
            if (producto.es_compuesto) {
                const componenteRows = document.querySelectorAll('.component-row');
                componenteRows.forEach(row => {
                    const productoComp = row.querySelector('.componente-producto').value;
                    const cantidad = parseInt(row.querySelector('.componente-cantidad').value);
                    if (productoComp && cantidad) {
                        producto.componentes.push({
                            producto: productoComp,
                            cantidad: cantidad
                        });
                    }
                });
            }
            
            productos.push(producto);
            actualizarTablaProductos();
            e.target.reset();
            document.getElementById('componentes-container').style.display = 'none';
            document.getElementById('componentes-list').innerHTML = '';
            mostrarAlerta('Producto registrado exitosamente', 'success');
        });

        function actualizarTablaProductos() {
            const tbody = document.querySelector('#tabla-productos tbody');
            tbody.innerHTML = '';
            
            productos.forEach(producto => {
                const estado = producto.stock_actual <= producto.stock_minimo ? 
                    '<span class="status-badge" style="background: #f8d7da; color: #721c24;">Stock Bajo</span>' : 
                    '<span class="status-badge status-entregado">Normal</span>';
                    
                const row = `
                    <tr>
                        <td>${producto.id}</td>
                        <td>${producto.nombre}</td>
                        <td>${producto.precio.toFixed(2)}</td>
                        <td>${producto.stock_actual} ${producto.unidad}</td>
                        <td>${producto.stock_minimo}</td>
                        <td>${estado}</td>
                        <td>
                            <button class="btn btn-warning" onclick="editarProducto('${producto.id}')">Editar</button>
                            <button class="btn" onclick="ajustarStock('${producto.id}')">Stock</button>
                            <button class="btn btn-danger" onclick="eliminarProducto('${producto.id}')">Eliminar</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function ajustarStock(id) {
            const producto = productos.find(p => p.id === id);
            if (producto) {
                const nuevoStock = prompt(`Stock actual: ${producto.stock_actual}\nIngrese nuevo stock:`, producto.stock_actual);
                if (nuevoStock !== null && !isNaN(nuevoStock)) {
                    producto.stock_actual = parseInt(nuevoStock);
                    actualizarTablaProductos();
                    mostrarAlerta('Stock actualizado exitosamente', 'success');
                }
            }
        }

        function eliminarProducto(id) {
            if (confirm('쮼st치 seguro de eliminar este producto?')) {
                productos = productos.filter(p => p.id !== id);
                actualizarTablaProductos();
                mostrarAlerta('Producto eliminado exitosamente', 'success');
            }
        }

        // Autocompletado de clientes
        document.getElementById('cliente-buscar').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const list = document.getElementById('cliente-list');
            
            if (query.length < 2) {
                list.style.display = 'none';
                return;
            }
            
            const matches = clientes.filter(cliente => 
                cliente.apellido.toLowerCase().includes(query) || 
                cliente.nombre.toLowerCase().includes(query)
            );
            
            if (matches.length > 0) {
                list.innerHTML = '';
                matches.forEach(cliente => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = `${cliente.apellido}, ${cliente.nombre} - ${cliente.telefono}`;
                    item.onclick = () => {
                        document.getElementById('cliente-buscar').value = `${cliente.apellido}, ${cliente.nombre}`;
                        document.getElementById('cliente-id').value = cliente.id;
                        list.style.display = 'none';
                    };
                    list.appendChild(item);
                });
                list.style.display = 'block';
            } else {
                list.style.display = 'none';
            }
        });

        // Autocompletado de productos
        function setupProductoAutocomplete(input) {
            input.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase();
                const list = e.target.parentNode.querySelector('.producto-list');
                
                if (query.length < 2) {
                    list.style.display = 'none';
                    return;
                }
                
                const matches = productos.filter(producto => 
                    producto.nombre.toLowerCase().includes(query) || 
                    producto.id.toLowerCase().includes(query)
                );
                
                if (matches.length > 0) {
                    list.innerHTML = '';
                    matches.forEach(producto => {
                        const item = document.createElement('div');
                        item.className = 'autocomplete-item';
                        item.textContent = `${producto.nombre} - ${producto.precio.toFixed(2)} (Stock: ${producto.stock_actual})`;
                        item.onclick = () => {
                            const row = e.target.closest('.product-row');
                            row.querySelector('.producto-buscar').value = producto.nombre;
                            row.querySelector('.producto-id').value = producto.id;
                            row.querySelector('.producto-precio').value = producto.precio.toFixed(2);
                            row.querySelector('.producto-cantidad').value = 1;
                            calcularSubtotal(row);
                            list.style.display = 'none';
                        };
                        list.appendChild(item);
                    });
                    list.style.display = 'block';
                } else {
                    list.style.display = 'none';
                }
            });
        }

        // Inicializar autocompletado para el primer producto
        document.addEventListener('DOMContentLoaded', function() {
            setupProductoAutocomplete(document.querySelector('.producto-buscar'));
            setupCantidadListener(document.querySelector('.producto-cantidad'));
        });

        function setupCantidadListener(input) {
            input.addEventListener('input', function() {
                const row = this.closest('.product-row');
                calcularSubtotal(row);
            });
        }

        function calcularSubtotal(row) {
            const cantidad = parseFloat(row.querySelector('.producto-cantidad').value) || 0;
            const precio = parseFloat(row.querySelector('.producto-precio').value) || 0;
            const subtotal = cantidad * precio;
            row.querySelector('.producto-subtotal').value = subtotal.toFixed(2);
            calcularTotal();
        }

        function calcularTotal() {
            const subtotales = document.querySelectorAll('.producto-subtotal');
            const costoEnvio = parseFloat(document.querySelector('input[name="costo_envio"]').value) || 0;
            let total = costoEnvio;
            
            subtotales.forEach(subtotal => {
                total += parseFloat(subtotal.value) || 0;
            });
            
            document.getElementById('total-compra').value = total.toFixed(2);
            calcularSaldo();
        }

        function calcularSaldo() {
            const total = parseFloat(document.getElementById('total-compra').value) || 0;
            const pagado = parseFloat(document.querySelector('input[name="monto_pagado"]').value) || 0;
            const saldo = total - pagado;
            document.getElementById('saldo-pendiente').value = saldo.toFixed(2);
        }

        // Event listeners para c치lculos
        document.querySelector('input[name="costo_envio"]').addEventListener('input', calcularTotal);
        document.querySelector('input[name="monto_pagado"]').addEventListener('input', calcularSaldo);

        function agregarProductoPedido() {
            const container = document.getElementById('productos-pedido');
            const newRow = document.querySelector('.product-row').cloneNode(true);
            
            // Limpiar valores
            newRow.querySelectorAll('input').forEach(input => {
                if (input.type === 'number') {
                    input.value = input.classList.contains('producto-cantidad') ? '1' : '';
                } else {
                    input.value = '';
                }
            });
            
            container.appendChild(newRow);
            
            // Setup listeners para la nueva fila
            setupProductoAutocomplete(newRow.querySelector('.producto-buscar'));
            setupCantidadListener(newRow.querySelector('.producto-cantidad'));
        }

        function eliminarProductoPedido(button) {
            const rows = document.querySelectorAll('.product-row');
            if (rows.length > 1) {
                button.closest('.product-row').remove();
                calcularTotal();
            } else {
                mostrarAlerta('Debe mantener al menos un producto', 'error');
            }
        }

        // Formulario de pedido
        document.getElementById('form-pedido').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const clienteId = document.getElementById('cliente-id').value;
            
            if (!clienteId) {
                mostrarAlerta('Debe seleccionar un cliente', 'error');
                return;
            }
            
            // Recopilar productos
            const productosRows = document.querySelectorAll('.product-row');
            const productosPedido = [];
            let validProducts = true;
            
            productosRows.forEach(row => {
                const productoId = row.querySelector('.producto-id').value;
                const cantidad = parseInt(row.querySelector('.producto-cantidad').value);
                const precio = parseFloat(row.querySelector('.producto-precio').value);
                
                if (productoId && cantidad > 0 && precio > 0) {
                    // Verificar stock
                    const producto = productos.find(p => p.id === productoId);
                    if (producto && producto.stock_actual >= cantidad) {
                        productosPedido.push({
                            producto_id: productoId,
                            nombre: producto.nombre,
                            cantidad: cantidad,
                            precio_unitario: precio,
                            subtotal: cantidad * precio
                        });
                        
                        // Actualizar stock
                        producto.stock_actual -= cantidad;
                        
                        // Si es producto compuesto, actualizar stock de componentes
                        if (producto.es_compuesto) {
                            producto.componentes.forEach(comp => {
                                const componenteProducto = productos.find(p => p.nombre === comp.producto);
                                if (componenteProducto) {
                                    componenteProducto.stock_actual -= (comp.cantidad * cantidad);
                                }
                            });
                        }
                    } else {
                        mostrarAlerta(`Stock insuficiente para ${producto.nombre}`, 'error');
                        validProducts = false;
                    }
                }
            });
            
            if (!validProducts || productosPedido.length === 0) {
                return;
            }
            
            const pedido = {
                id: nextPedidoId++,
                cliente_id: parseInt(clienteId),
                cliente_nombre: document.getElementById('cliente-buscar').value,
                productos: productosPedido,
                fecha_pedido: new Date().toISOString(),
                fecha_entrega: formData.get('fecha_entrega'),
                turno_entrega: formData.get('turno_entrega'),
                costo_envio: parseFloat(formData.get('costo_envio')) || 0,
                total_compra: parseFloat(formData.get('total_compra')),
                forma_pago: formData.get('forma_pago'),
                monto_pagado: parseFloat(formData.get('monto_pagado')) || 0,
                saldo_pendiente: parseFloat(formData.get('saldo_pendiente')) || 0,
                estado_pago: parseFloat(formData.get('saldo_pendiente')) <= 0 ? 'pagado' : 'pendiente',
                estado_entrega: 'pendiente'
            };
            
            pedidos.push(pedido);
            actualizarTablaProductos(); // Para reflejar el stock actualizado
            e.target.reset();
            document.getElementById('cliente-id').value = '';
            
            // Resetear productos del pedido
            const container = document.getElementById('productos-pedido');
            container.innerHTML = `
                <div class="product-row">
                    <div class="form-row">
                        <div class="form-group autocomplete-container">
                            <label>Producto</label>
                            <input type="text" class="producto-buscar" placeholder="Buscar producto..." autocomplete="off">
                            <div class="autocomplete-list producto-list"></div>
                            <input type="hidden" class="producto-id">
                        </div>
                        <div class="form-group">
                            <label>Cantidad</label>
                            <input type="number" class="producto-cantidad" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label>Precio Unitario</label>
                            <input type="number" class="producto-precio" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                            <label>Subtotal</label>
                            <input type="number" class="producto-subtotal" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-danger" onclick="eliminarProductoPedido(this)">Eliminar</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Reinicializar listeners
            setupProductoAutocomplete(document.querySelector('.producto-buscar'));
            setupCantidadListener(document.querySelector('.producto-cantidad'));
            
            mostrarAlerta('Pedido creado exitosamente', 'success');
        });

        // Lista de pedidos
        function cargarListaPedidos() {
            const container = document.getElementById('lista-pedidos-container');
            container.innerHTML = '';
            
            // Filtrar y ordenar pedidos
            let pedidosFiltrados = [...pedidos];
            const filtroEstado = document.getElementById('filtro-estado').value;
            
            if (filtroEstado !== 'todos') {
                pedidosFiltrados = pedidosFiltrados.filter(pedido => {
                    switch (filtroEstado) {
                        case 'pendiente_entrega':
                            return pedido.estado_entrega === 'pendiente';
                        case 'pendiente_pago':
                            return pedido.estado_pago === 'pendiente';
                        case 'completados':
                            return pedido.estado_pago === 'pagado' && pedido.estado_entrega === 'entregado';
                        default:
                            return true;
                    }
                });
            }
            
            // Ordenar por fecha de entrega (m치s pr칩xima primero)
            pedidosFiltrados.sort((a, b) => new Date(a.fecha_entrega) - new Date(b.fecha_entrega));
            
            pedidosFiltrados.forEach(pedido => {
                const pedidoCard = crearCardPedido(pedido);
                container.appendChild(pedidoCard);
            });
        }

        function crearCardPedido(pedido) {
            const div = document.createElement('div');
            div.className = 'card';
            div.style.marginBottom = '15px';
            
            const estadoPago = pedido.estado_pago === 'pagado' ? 
                '<span class="status-badge status-pagado">Pagado</span>' : 
                '<span class="status-badge status-pendiente">Pendiente Pago</span>';
                
            const estadoEntrega = pedido.estado_entrega === 'entregado' ? 
                '<span class="status-badge status-entregado">Entregado</span>' : 
                '<span class="status-badge status-pendiente">Pendiente Entrega</span>';
            
            const fechaEntrega = new Date(pedido.fecha_entrega).toLocaleDateString('es-AR');
            
            let productosHtml = '';
            pedido.productos.forEach(prod => {
                productosHtml += `<li>${prod.nombre} x${prod.cantidad} - ${prod.subtotal.toFixed(2)}</li>`;
            });
            
            div.innerHTML = `
                <div class="card-header">
                    Pedido #${pedido.id} - ${pedido.cliente_nombre}
                    <div style="float: right;">
                        ${estadoPago} ${estadoEntrega}
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <strong>Fecha de Entrega:</strong> ${fechaEntrega} (${pedido.turno_entrega})
                    </div>
                    <div class="form-group">
                        <strong>Total:</strong> ${pedido.total_compra.toFixed(2)}
                    </div>
                    <div class="form-group">
                        <strong>Saldo:</strong> ${pedido.saldo_pendiente.toFixed(2)}
                    </div>
                </div>
                <div><strong>Productos:</strong></div>
                <ul>${productosHtml}</ul>
                <div style="margin-top: 15px;">
                    ${pedido.estado_pago === 'pendiente' ? 
                        `<button class="btn btn-success" onclick="marcarPagado(${pedido.id})">Marcar como Pagado</button>` : ''}
                    ${pedido.estado_entrega === 'pendiente' ? 
                        `<button class="btn btn-warning" onclick="marcarEntregado(${pedido.id})">Marcar como Entregado</button>` : ''}
                    <button class="btn btn-danger" onclick="eliminarPedido(${pedido.id})">Eliminar Pedido</button>
                </div>
            `;
            
            return div;
        }

        function marcarPagado(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (pedido) {
                pedido.estado_pago = 'pagado';
                pedido.saldo_pendiente = 0;
                pedido.monto_pagado = pedido.total_compra;
                cargarListaPedidos();
                mostrarAlerta('Pedido marcado como pagado', 'success');
            }
        }

        function marcarEntregado(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (pedido) {
                pedido.estado_entrega = 'entregado';
                pedido.fecha_entrega_real = new Date().toISOString();
                cargarListaPedidos();
                mostrarAlerta('Pedido marcado como entregado', 'success');
            }
        }

        function eliminarPedido(pedidoId) {
            if (confirm('쮼st치 seguro de eliminar este pedido? Se restaurar치 el stock de los productos.')) {
                const pedido = pedidos.find(p => p.id === pedidoId);
                if (pedido) {
                    // Restaurar stock
                    pedido.productos.forEach(prodPedido => {
                        const producto = productos.find(p => p.id === prodPedido.producto_id);
                        if (producto) {
                            producto.stock_actual += prodPedido.cantidad;
                        }
                    });
                    
                    pedidos = pedidos.filter(p => p.id !== pedidoId);
                    cargarListaPedidos();
                    actualizarTablaProductos();
                    mostrarAlerta('Pedido eliminado y stock restaurado', 'success');
                }
            }
        }

        function filtrarPedidos() {
            cargarListaPedidos();
        }

        function ordenarPedidos() {
            cargarListaPedidos();
        }

        // Gesti칩n de pagos
        function cargarPedidosConSaldo() {
            const container = document.getElementById('pedidos-con-saldo');
            container.innerHTML = '';
            
            const pedidosPendientes = pedidos.filter(p => p.saldo_pendiente > 0);
            
            if (pedidosPendientes.length === 0) {
                container.innerHTML = '<p>No hay pedidos con saldo pendiente.</p>';
                return;
            }
            
            pedidosPendientes.forEach(pedido => {
                const div = document.createElement('div');
                div.className = 'card';
                div.style.marginBottom = '15px';
                
                div.innerHTML = `
                    <div class="card-header">
                        Pedido #${pedido.id} - ${pedido.cliente_nombre}
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <strong>Total:</strong> ${pedido.total_compra.toFixed(2)}
                        </div>
                        <div class="form-group">
                            <strong>Pagado:</strong> ${pedido.monto_pagado.toFixed(2)}
                        </div>
                        <div class="form-group">
                            <strong>Saldo:</strong> ${pedido.saldo_pendiente.toFixed(2)}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Monto a Pagar</label>
                            <input type="number" id="pago-${pedido.id}" step="0.01" max="${pedido.saldo_pendiente}" value="${pedido.saldo_pendiente}">
                        </div>
                        <div class="form-group">
                            <label>Forma de Pago</label>
                            <select id="forma-pago-${pedido.id}">
                                <option value="efectivo">Efectivo</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="mercadopago">MercadoPago</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-success" onclick="registrarPago(${pedido.id})">Registrar Pago</button>
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function registrarPago(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            const monto = parseFloat(document.getElementById(`pago-${pedidoId}`).value);
            const formaPago = document.getElementById(`forma-pago-${pedidoId}`).value;
            
            if (monto <= 0 || monto > pedido.saldo_pendiente) {
                mostrarAlerta('Monto inv치lido', 'error');
                return;
            }
            
            // Registrar el pago
            const pago = {
                id: Date.now(),
                pedido_id: pedidoId,
                monto: monto,
                forma_pago: formaPago,
                fecha: new Date().toISOString()
            };
            
            pagos.push(pago);
            
            // Actualizar el pedido
            pedido.monto_pagado += monto;
            pedido.saldo_pendiente -= monto;
            
            if (pedido.saldo_pendiente <= 0) {
                pedido.estado_pago = 'pagado';
                pedido.saldo_pendiente = 0;
            }
            
            cargarPedidosConSaldo();
            mostrarAlerta('Pago registrado exitosamente', 'success');
        }

        // Dashboard
        function actualizarDashboard() {
            // Estad칤sticas b치sicas
            document.getElementById('total-clientes').textContent = clientes.length;
            document.getElementById('total-productos').textContent = productos.length;
            
            const pedidosPendientes = pedidos.filter(p => 
                p.estado_entrega === 'pendiente' || p.estado_pago === 'pendiente'
            ).length;
            document.getElementById('pedidos-pendientes').textContent = pedidosPendientes;
            
            // Ingresos del mes actual
            const fechaActual = new Date();
            const inicioMes = new Date(fechaActual.getFullYear(), fechaActual.getMonth(), 1);
            const ingresosMes = pedidos
                .filter(p => new Date(p.fecha_pedido) >= inicioMes && p.estado_pago === 'pagado')
                .reduce((sum, p) => sum + p.total_compra, 0);
            document.getElementById('ingresos-mes').textContent = `${ingresosMes.toFixed(2)}`;
            
            // Pr칩ximas entregas
            cargarProximasEntregas();
            
            // Stock bajo
            cargarStockBajo();
        }

        function cargarProximasEntregas() {
            const container = document.getElementById('proximas-entregas');
            const proximasEntregas = pedidos
                .filter(p => p.estado_entrega === 'pendiente')
                .sort((a, b) => new Date(a.fecha_entrega) - new Date(b.fecha_entrega))
                .slice(0, 5);
            
            if (proximasEntregas.length === 0) {
                container.innerHTML = '<p>No hay entregas pendientes.</p>';
                return;
            }
            
            let html = '<ul>';
            proximasEntregas.forEach(pedido => {
                const fecha = new Date(pedido.fecha_entrega).toLocaleDateString('es-AR');
                html += `<li><strong>${pedido.cliente_nombre}</strong> - ${fecha} (${pedido.turno_entrega}) - ${pedido.total_compra.toFixed(2)}</li>`;
            });
            html += '</ul>';
            
            container.innerHTML = html;
        }

        function cargarStockBajo() {
            const container = document.getElementById('stock-bajo');
            const productosStockBajo = productos.filter(p => p.stock_actual <= p.stock_minimo);
            
            if (productosStockBajo.length === 0) {
                container.innerHTML = '<p>Todos los productos tienen stock suficiente.</p>';
                return;
            }
            
            let html = '<ul>';
            productosStockBajo.forEach(producto => {
                html += `<li><strong>${producto.nombre}</strong> - Stock: ${producto.stock_actual} (M칤nimo: ${producto.stock_minimo})</li>`;
            });
            html += '</ul>';
            
            container.innerHTML = html;
        }

        // Estad칤sticas
        function generarEstadisticas() {
            const fechaDesde = document.getElementById('fecha-desde').value;
            const fechaHasta = document.getElementById('fecha-hasta').value;
            
            if (!fechaDesde || !fechaHasta) {
                mostrarAlerta('Debe seleccionar ambas fechas', 'error');
                return;
            }
            
            const inicio = new Date(fechaDesde);
            const fin = new Date(fechaHasta);
            fin.setHours(23, 59, 59, 999);
            
            const pedidosPeriodo = pedidos.filter(p => {
                const fechaPedido = new Date(p.fecha_pedido);
                return fechaPedido >= inicio && fechaPedido <= fin;
            });
            
            // Estad칤sticas generales
            const statsGrid = document.getElementById('estadisticas-grid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${pedidosPeriodo.length}</div>
                    <div class="stat-label">Total Pedidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${pedidosPeriodo.reduce((sum, p) => sum + p.total_compra, 0).toFixed(2)}</div>
                    <div class="stat-label">Ingresos Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${pedidosPeriodo.filter(p => p.estado_pago === 'pagado').length}</div>
                    <div class="stat-label">Pedidos Pagados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${pedidosPeriodo.filter(p => p.estado_entrega === 'entregado').length}</div>
                    <div class="stat-label">Pedidos Entregados</div>
                </div>
            `;
            
            // Reportes detallados
            const reportesContainer = document.getElementById('reportes-detallados');
            reportesContainer.innerHTML = '';
            
            // Productos m치s vendidos
            const productosVendidos = {};
            pedidosPeriodo.forEach(pedido => {
                pedido.productos.forEach(prod => {
                    if (productosVendidos[prod.nombre]) {
                        productosVendidos[prod.nombre] += prod.cantidad;
                    } else {
                        productosVendidos[prod.nombre] = prod.cantidad;
                    }
                });
            });
            
            const topProductos = Object.entries(productosVendidos)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            // Clientes m치s frecuentes
            const clientesFrecuentes = {};
            pedidosPeriodo.forEach(pedido => {
                if (clientesFrecuentes[pedido.cliente_nombre]) {
                    clientesFrecuentes[pedido.cliente_nombre]++;
                } else {
                    clientesFrecuentes[pedido.cliente_nombre] = 1;
                }
            });
            
            const topClientes = Object.entries(clientesFrecuentes)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            // Formas de pago
            const formasPago = {};
            pedidosPeriodo.forEach(pedido => {
                if (formasPago[pedido.forma_pago]) {
                    formasPago[pedido.forma_pago]++;
                } else {
                    formasPago[pedido.forma_pago] = 1;
                }
            });
            
            // Crear tarjetas de reportes
            reportesContainer.innerHTML = `
                <div class="card">
                    <div class="card-header">Top 5 Productos M치s Vendidos</div>
                    <table class="table">
                        <thead>
                            <tr><th>Producto</th><th>Cantidad Vendida</th></tr>
                        </thead>
                        <tbody>
                            ${topProductos.map(([nombre, cantidad]) => 
                                `<tr><td>${nombre}</td><td>${cantidad}</td></tr>`
                            ).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">Top 5 Clientes M치s Frecuentes</div>
                    <table class="table">
                        <thead>
                            <tr><th>Cliente</th><th>Cantidad de Pedidos</th></tr>
                        </thead>
                        <tbody>
                            ${topClientes.map(([nombre, cantidad]) => 
                                `<tr><td>${nombre}</td><td>${cantidad}</td></tr>`
                            ).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="card">
                    <div class="card-header">Formas de Pago Utilizadas</div>
                    <table class="table">
                        <thead>
                            <tr><th>Forma de Pago</th><th>Cantidad de Pedidos</th></tr>
                        </thead>
                        <tbody>
                            ${Object.entries(formasPago).map(([forma, cantidad]) => 
                                `<tr><td>${forma.charAt(0).toUpperCase() + forma.slice(1)}</td><td>${cantidad}</td></tr>`
                            ).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Utilidades
        function mostrarAlerta(mensaje, tipo) {
            const alertaExistente = document.querySelector('.alert');
            if (alertaExistente) {
                alertaExistente.remove();
            }
            
            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo === 'error' ? 'error' : 'success'}`;
            alerta.textContent = mensaje;
            
            document.querySelector('.container').insertBefore(alerta, document.querySelector('.header').nextSibling);
            
            setTimeout(() => {
                alerta.remove();
            }, 3000);
        }

        // Inicializaci칩n
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar datos de ejemplo para demo
            cargarDatosEjemplo();
            
            // Actualizar dashboard inicial
            actualizarDashboard();
            actualizarTablaClientes();
            actualizarTablaProductos();
            
            // Configurar fechas por defecto para estad칤sticas
            const hoy = new Date();
            const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            document.getElementById('fecha-desde').value = inicioMes.toISOString().split('T')[0];
            document.getElementById('fecha-hasta').value = hoy.toISOString().split('T')[0];
            
            // Configurar fecha m칤nima para pedidos (hoy)
            const fechaEntregaInput = document.querySelector('input[name="fecha_entrega"]');
            if (fechaEntregaInput) {
                fechaEntregaInput.min = hoy.toISOString().split('T')[0];
            }
        });

        function cargarDatosEjemplo() {
            // Clientes de ejemplo
            clientes.push(
                {
                    id: nextClienteId++,
                    nombre: 'Juan',
                    apellido: 'P칠rez',
                    telefono: '11-1234-5678',
                    direccion: {
                        calle: 'Av. Corrientes',
                        numero: '1234',
                        piso: '2A',
                        codigo_postal: '1043',
                        localidad: 'CABA'
                    },
                    email: 'juan.perez@email.com',
                    fecha_registro: new Date().toISOString()
                },
                {
                    id: nextClienteId++,
                    nombre: 'Mar칤a',
                    apellido: 'Gonz치lez',
                    telefono: '11-9876-5432',
                    direccion: {
                        calle: 'San Mart칤n',
                        numero: '567',
                        piso: '',
                        codigo_postal: '1602',
                        localidad: 'Florida'
                    },
                    email: 'maria.gonzalez@email.com',
                    fecha_registro: new Date().toISOString()
                }
            );

            // Productos de ejemplo
            productos.push(
                {
                    id: 'PAST001',
                    nombre: 'Pastrami Cl치sico',
                    precio: 1200.00,
                    stock_inicial: 50,
                    stock_actual: 45,
                    stock_minimo: 10,
                    unidad: 'unidades',
                    es_compuesto: false,
                    componentes: [],
                    fecha_registro: new Date().toISOString()
                },
                {
                    id: 'PAST002',
                    nombre: 'Pastrami Premium',
                    precio: 1500.00,
                    stock_inicial: 30,
                    stock_actual: 25,
                    stock_minimo: 5,
                    unidad: 'unidades',
                    es_compuesto: false,
                    componentes: [],
                    fecha_registro: new Date().toISOString()
                },
                {
                    id: 'CAJA001',
                    nombre: 'Caja Mixta x6',
                    precio: 6500.00,
                    stock_inicial: 20,
                    stock_actual: 18,
                    stock_minimo: 3,
                    unidad: 'cajas',
                    es_compuesto: true,
                    componentes: [
                        { producto: 'Pastrami Cl치sico', cantidad: 3 },
                        { producto: 'Pastrami Premium', cantidad: 3 }
                    ],
                    fecha_registro: new Date().toISOString()
                }
            );

            // Pedido de ejemplo
            const fechaEntrega = new Date();
            fechaEntrega.setDate(fechaEntrega.getDate() + 2);
            
            pedidos.push({
                id: nextPedidoId++,
                cliente_id: 1,
                cliente_nombre: 'P칠rez, Juan',
                productos: [
                    {
                        producto_id: 'PAST001',
                        nombre: 'Pastrami Cl치sico',
                        cantidad: 2,
                        precio_unitario: 1200.00,
                        subtotal: 2400.00
                    }
                ],
                fecha_pedido: new Date().toISOString(),
                fecha_entrega: fechaEntrega.toISOString().split('T')[0],
                turno_entrega: 'tarde',
                costo_envio: 200.00,
                total_compra: 2600.00,
                forma_pago: 'efectivo',
                monto_pagado: 1000.00,
                saldo_pendiente: 1600.00,
                estado_pago: 'pendiente',
                estado_entrega: 'pendiente'
            });
        }

        // Cerrar listas de autocompletado al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.autocomplete-container')) {
                document.querySelectorAll('.autocomplete-list').forEach(list => {
                    list.style.display = 'none';
                });
            }
        });

        // Funci칩n para exportar datos (para futuras implementaciones)
        function exportarDatos() {
            const datos = {
                clientes: clientes,
                productos: productos,
                pedidos: pedidos,
                pagos: pagos,
                exportado: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(datos, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `pastrami_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Funci칩n para importar datos (para futuras implementaciones)
        function importarDatos(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const datos = JSON.parse(e.target.result);
                        
                        if (datos.clientes) clientes = datos.clientes;
                        if (datos.productos) productos = datos.productos;
                        if (datos.pedidos) pedidos = datos.pedidos;
                        if (datos.pagos) pagos = datos.pagos;
                        
                        // Actualizar IDs siguientes
                        if (clientes.length > 0) {
                            nextClienteId = Math.max(...clientes.map(c => c.id)) + 1;
                        }
                        if (pedidos.length > 0) {
                            nextPedidoId = Math.max(...pedidos.map(p => p.id)) + 1;
                        }
                        
                        // Actualizar todas las tablas
                        actualizarTablaClientes();
                        actualizarTablaProductos();
                        actualizarDashboard();
                        
                        mostrarAlerta('Datos importados exitosamente', 'success');
                    } catch (error) {
                        mostrarAlerta('Error al importar los datos', 'error');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Funciones adicionales para mobile
        function optimizarParaMobile() {
            if (window.innerWidth <= 768) {
                // Ajustar tablas para mobile
                document.querySelectorAll('.table').forEach(table => {
                    table.style.fontSize = '14px';
                });
                
                // Hacer formularios m치s compactos
                document.querySelectorAll('.form-row').forEach(row => {
                    row.style.flexDirection = 'column';
                });
            }
        }

        // Event listener para redimensionamiento
        window.addEventListener('resize', optimizarParaMobile);

        // Aplicar optimizaci칩n inicial
        document.addEventListener('DOMContentLoaded', optimizarParaMobile);

        // Funci칩n para validar datos antes de enviar
        function validarFormulario(form) {
            const inputs = form.querySelectorAll('input[required]');
            let valido = true;
            
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    input.style.borderColor = '#e74c3c';
                    valido = false;
                } else {
                    input.style.borderColor = '#e1e8ed';
                }
            });
            
            return valido;
        }

        // Funci칩n para limpiar formularios
        function limpiarFormulario(formId) {
            const form = document.getElementById(formId);
            if (form) {
                form.reset();
                
                // Limpiar campos ocultos
                form.querySelectorAll('input[type="hidden"]').forEach(input => {
                    input.value = '';
                });
                
                // Ocultar listas de autocompletado
                form.querySelectorAll('.autocomplete-list').forEach(list => {
                    list.style.display = 'none';
                });
            }
        }

        // Funciones de edici칩n (para futuras implementaciones)
        function editarCliente(id) {
            const cliente = clientes.find(c => c.id === id);
            if (cliente) {
                // Implementar modal o formulario de edici칩n
                mostrarAlerta('Funci칩n de edici칩n en desarrollo', 'error');
            }
        }

        function editarProducto(id) {
            const producto = productos.find(p => p.id === id);
            if (producto) {
                // Implementar modal o formulario de edici칩n
                mostrarAlerta('Funci칩n de edici칩n en desarrollo', 'error');
            }
        }

        // Funciones de b칰squeda avanzada
        function buscarClientes(termino) {
            return clientes.filter(cliente => 
                cliente.nombre.toLowerCase().includes(termino.toLowerCase()) ||
                cliente.apellido.toLowerCase().includes(termino.toLowerCase()) ||
                cliente.telefono.includes(termino)
            );
        }

        function buscarProductos(termino) {
            return productos.filter(producto => 
                producto.nombre.toLowerCase().includes(termino.toLowerCase()) ||
                producto.id.toLowerCase().includes(termino.toLowerCase())
            );
        }

        // Funci칩n para calcular estad칤sticas avanzadas
        function calcularEstadisticasAvanzadas(fechaInicio, fechaFin) {
            const pedidosPeriodo = pedidos.filter(p => {
                const fecha = new Date(p.fecha_pedido);
                return fecha >= fechaInicio && fecha <= fechaFin;
            });
            
            return {
                totalPedidos: pedidosPeriodo.length,
                totalIngresos: pedidosPeriodo.reduce((sum, p) => sum + p.total_compra, 0),
                promedioTicket: pedidosPeriodo.length > 0 ? 
                    pedidosPeriodo.reduce((sum, p) => sum + p.total_compra, 0) / pedidosPeriodo.length : 0,
                clientesUnicos: new Set(pedidosPeriodo.map(p => p.cliente_id)).size,
                tasaConversion: pedidosPeriodo.length > 0 ? 
                    (pedidosPeriodo.filter(p => p.estado_pago === 'pagado').length / pedidosPeriodo.length) * 100 : 0
            };
        }

        console.log('游볽 Sistema Pastrami cargado correctamente');
        console.log('九 Todas las funcionalidades implementadas');
        console.log('游님 Responsive design activado');
        console.log('游댃 Sistema listo para sincronizaci칩n con Firebase');
    </script>
</body>
</html>
