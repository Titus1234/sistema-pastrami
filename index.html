import React, { useState, useEffect } from 'react';
import { Search, Plus, User, Package, ShoppingCart, CreditCard, BarChart3, Filter, Calendar, DollarSign, MapPin, Phone, Mail } from 'lucide-react';

const PastramiApp = () => {
  // Estados principales
  const [activeSection, setActiveSection] = useState('pedidos');
  const [clientes, setClientes] = useState([]);
  const [productos, setProductos] = useState([]);
  const [pedidos, setPedidos] = useState([]);
  const [pagos, setPagos] = useState([]);
  
  // Estados para formularios
  const [showClienteForm, setShowClienteForm] = useState(false);
  const [showProductoForm, setShowProductoForm] = useState(false);
  const [showPedidoForm, setShowPedidoForm] = useState(false);
  const [filtros, setFiltros] = useState({});

  // Inicializar datos de ejemplo
  useEffect(() => {
    // Datos iniciales de ejemplo
    setClientes([
      {
        id: 1,
        nombre: 'Juan',
        apellido: 'Pérez',
        telefono: '11-4567-8900',
        direccion: {
          calle: 'Av. Corrientes',
          numero: '1234',
          piso: '5A',
          codigoPostal: '1043',
          localidad: 'Capital Federal'
        },
        email: 'juan.perez@email.com'
      }
    ]);

    setProductos([
      {
        id: 'PASTR001',
        nombre: 'Pastrami Clásico 500g',
        componentes: [
          { item: 'Carne pastrami', cantidad: 500, unidad: 'gramos' }
        ]
      },
      {
        id: 'COMBO001',
        nombre: 'Combo Familiar',
        componentes: [
          { item: 'Pastrami', cantidad: 1, unidad: 'kg' },
          { item: 'Pan de centeno', cantidad: 2, unidad: 'unidades' },
          { item: 'Pepinillos', cantidad: 1, unidad: 'frasco' }
        ]
      }
    ]);
  }, []);

  // Componente para formulario de cliente
  const ClienteForm = ({ cliente = null, onSave, onCancel }) => {
    const [formData, setFormData] = useState({
      nombre: cliente?.nombre || '',
      apellido: cliente?.apellido || '',
      telefono: cliente?.telefono || '',
      calle: cliente?.direccion?.calle || '',
      numero: cliente?.direccion?.numero || '',
      piso: cliente?.direccion?.piso || '',
      codigoPostal: cliente?.direccion?.codigoPostal || '',
      localidad: cliente?.direccion?.localidad || '',
      email: cliente?.email || ''
    });

    const handleSubmit = (e) => {
      e.preventDefault();
      const nuevoCliente = {
        id: cliente?.id || Date.now(),
        nombre: formData.nombre,
        apellido: formData.apellido,
        telefono: formData.telefono,
        direccion: {
          calle: formData.calle,
          numero: formData.numero,
          piso: formData.piso,
          codigoPostal: formData.codigoPostal,
          localidad: formData.localidad
        },
        email: formData.email
      };
      onSave(nuevoCliente);
    };

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div className="bg-white rounded-lg p-6 w-full max-w-md max-h-screen overflow-y-auto">
          <h3 className="text-lg font-bold mb-4">{cliente ? 'Editar Cliente' : 'Nuevo Cliente'}</h3>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <input
                type="text"
                placeholder="Nombre *"
                value={formData.nombre}
                onChange={(e) => setFormData({...formData, nombre: e.target.value})}
                className="border rounded p-2"
                required
              />
              <input
                type="text"
                placeholder="Apellido *"
                value={formData.apellido}
                onChange={(e) => setFormData({...formData, apellido: e.target.value})}
                className="border rounded p-2"
                required
              />
            </div>
            <input
              type="tel"
              placeholder="Teléfono *"
              value={formData.telefono}
              onChange={(e) => setFormData({...formData, telefono: e.target.value})}
              className="w-full border rounded p-2"
              required
            />
            <div className="grid grid-cols-3 gap-2">
              <input
                type="text"
                placeholder="Calle"
                value={formData.calle}
                onChange={(e) => setFormData({...formData, calle: e.target.value})}
                className="border rounded p-2 col-span-2"
              />
              <input
                type="text"
                placeholder="Número"
                value={formData.numero}
                onChange={(e) => setFormData({...formData, numero: e.target.value})}
                className="border rounded p-2"
              />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <input
                type="text"
                placeholder="Piso/Depto"
                value={formData.piso}
                onChange={(e) => setFormData({...formData, piso: e.target.value})}
                className="border rounded p-2"
              />
              <input
                type="text"
                placeholder="Código Postal"
                value={formData.codigoPostal}
                onChange={(e) => setFormData({...formData, codigoPostal: e.target.value})}
                className="border rounded p-2"
              />
            </div>
            <input
              type="text"
              placeholder="Localidad"
              value={formData.localidad}
              onChange={(e) => setFormData({...formData, localidad: e.target.value})}
              className="w-full border rounded p-2"
            />
            <input
              type="email"
              placeholder="Email"
              value={formData.email}
              onChange={(e) => setFormData({...formData, email: e.target.value})}
              className="w-full border rounded p-2"
            />
            <div className="flex gap-2">
              <button type="submit" className="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                Guardar
              </button>
              <button type="button" onClick={onCancel} className="flex-1 bg-gray-300 py-2 rounded hover:bg-gray-400">
                Cancelar
              </button>
            </div>
          </form>
        </div>
      </div>
    );
  };

  // Componente para formulario de producto
  const ProductoForm = ({ producto = null, onSave, onCancel }) => {
    const [formData, setFormData] = useState({
      id: producto?.id || '',
      nombre: producto?.nombre || '',
      componentes: producto?.componentes || [{ item: '', cantidad: '', unidad: '' }]
    });

    const agregarComponente = () => {
      setFormData({
        ...formData,
        componentes: [...formData.componentes, { item: '', cantidad: '', unidad: '' }]
      });
    };

    const eliminarComponente = (index) => {
      const nuevosComponentes = formData.componentes.filter((_, i) => i !== index);
      setFormData({ ...formData, componentes: nuevosComponentes });
    };

    const actualizarComponente = (index, campo, valor) => {
      const nuevosComponentes = [...formData.componentes];
      nuevosComponentes[index][campo] = valor;
      setFormData({ ...formData, componentes: nuevosComponentes });
    };

    const handleSubmit = (e) => {
      e.preventDefault();
      const nuevoProducto = {
        id: formData.id || `PROD${Date.now()}`,
        nombre: formData.nombre,
        componentes: formData.componentes.filter(c => c.item && c.cantidad)
      };
      onSave(nuevoProducto);
    };

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div className="bg-white rounded-lg p-6 w-full max-w-md max-h-screen overflow-y-auto">
          <h3 className="text-lg font-bold mb-4">{producto ? 'Editar Producto' : 'Nuevo Producto'}</h3>
          <form onSubmit={handleSubmit} className="space-y-4">
            <input
              type="text"
              placeholder="ID del Producto"
              value={formData.id}
              onChange={(e) => setFormData({...formData, id: e.target.value})}
              className="w-full border rounded p-2"
              required
            />
            <input
              type="text"
              placeholder="Nombre del Producto"
              value={formData.nombre}
              onChange={(e) => setFormData({...formData, nombre: e.target.value})}
              className="w-full border rounded p-2"
              required
            />
            
            <div className="space-y-2">
              <label className="font-semibold">Componentes:</label>
              {formData.componentes.map((componente, index) => (
                <div key={index} className="flex gap-2 items-center">
                  <input
                    type="text"
                    placeholder="Item"
                    value={componente.item}
                    onChange={(e) => actualizarComponente(index, 'item', e.target.value)}
                    className="flex-1 border rounded p-2 text-sm"
                  />
                  <input
                    type="number"
                    placeholder="Cant."
                    value={componente.cantidad}
                    onChange={(e) => actualizarComponente(index, 'cantidad', e.target.value)}
                    className="w-16 border rounded p-2 text-sm"
                  />
                  <input
                    type="text"
                    placeholder="Unidad"
                    value={componente.unidad}
                    onChange={(e) => actualizarComponente(index, 'unidad', e.target.value)}
                    className="w-20 border rounded p-2 text-sm"
                  />
                  {formData.componentes.length > 1 && (
                    <button
                      type="button"
                      onClick={() => eliminarComponente(index)}
                      className="text-red-600 hover:text-red-800 text-sm"
                    >
                      ✕
                    </button>
                  )}
                </div>
              ))}
              <button
                type="button"
                onClick={agregarComponente}
                className="text-blue-600 hover:text-blue-800 text-sm"
              >
                + Agregar componente
              </button>
            </div>

            <div className="flex gap-2">
              <button type="submit" className="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                Guardar
              </button>
              <button type="button" onClick={onCancel} className="flex-1 bg-gray-300 py-2 rounded hover:bg-gray-400">
                Cancelar
              </button>
            </div>
          </form>
        </div>
      </div>
    );
  };

  // Componente para formulario de pedido
  const PedidoForm = ({ pedido = null, onSave, onCancel }) => {
    const [formData, setFormData] = useState({
      clienteId: pedido?.clienteId || '',
      productos: pedido?.productos || [{ productoId: '', cantidad: 1, precioUnitario: 0 }],
      costoEnvio: pedido?.costoEnvio || 0,
      fechaEntrega: pedido?.fechaEntrega || '',
      turno: pedido?.turno || 'mañana',
      formaPago: pedido?.formaPago || 'efectivo',
      pagadoACuenta: pedido?.pagadoACuenta || 0
    });

    const [busquedaCliente, setBusquedaCliente] = useState('');
    const [clientesFiltrados, setClientesFiltrados] = useState([]);

    useEffect(() => {
      if (busquedaCliente) {
        const filtrados = clientes.filter(c => 
          c.nombre.toLowerCase().includes(busquedaCliente.toLowerCase()) ||
          c.apellido.toLowerCase().includes(busquedaCliente.toLowerCase())
        );
        setClientesFiltrados(filtrados);
      } else {
        setClientesFiltrados([]);
      }
    }, [busquedaCliente, clientes]);

    const calcularTotal = () => {
      const totalProductos = formData.productos.reduce((sum, p) => sum + (p.cantidad * p.precioUnitario), 0);
      return totalProductos + parseFloat(formData.costoEnvio || 0);
    };

    const agregarProducto = () => {
      setFormData({
        ...formData,
        productos: [...formData.productos, { productoId: '', cantidad: 1, precioUnitario: 0 }]
      });
    };

    const eliminarProducto = (index) => {
      const nuevosProductos = formData.productos.filter((_, i) => i !== index);
      setFormData({ ...formData, productos: nuevosProductos });
    };

    const actualizarProducto = (index, campo, valor) => {
      const nuevosProductos = [...formData.productos];
      nuevosProductos[index][campo] = valor;
      setFormData({ ...formData, productos: nuevosProductos });
    };

    const handleSubmit = (e) => {
      e.preventDefault();
      const total = calcularTotal();
      const nuevoPedido = {
        id: pedido?.id || Date.now(),
        clienteId: formData.clienteId,
        productos: formData.productos.filter(p => p.productoId),
        costoEnvio: parseFloat(formData.costoEnvio),
        total: total,
        fechaEntrega: formData.fechaEntrega,
        turno: formData.turno,
        formaPago: formData.formaPago,
        pagadoACuenta: parseFloat(formData.pagadoACuenta),
        saldoPendiente: total - parseFloat(formData.pagadoACuenta),
        fecha: new Date().toISOString().split('T')[0],
        estado: 'pendiente'
      };
      onSave(nuevoPedido);
    };

    const clienteSeleccionado = clientes.find(c => c.id.toString() === formData.clienteId.toString());

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div className="bg-white rounded-lg p-6 w-full max-w-2xl max-h-screen overflow-y-auto">
          <h3 className="text-lg font-bold mb-4">{pedido ? 'Editar Pedido' : 'Nuevo Pedido'}</h3>
          <form onSubmit={handleSubmit} className="space-y-4">
            
            {/* Selección de Cliente */}
            <div className="space-y-2">
              <label className="font-semibold">Cliente:</label>
              <input
                type="text"
                placeholder="Buscar cliente..."
                value={busquedaCliente}
                onChange={(e) => setBusquedaCliente(e.target.value)}
                className="w-full border rounded p-2"
              />
              {clientesFiltrados.length > 0 && (
                <div className="border rounded max-h-32 overflow-y-auto">
                  {clientesFiltrados.map(cliente => (
                    <div
                      key={cliente.id}
                      onClick={() => {
                        setFormData({...formData, clienteId: cliente.id});
                        setBusquedaCliente(`${cliente.nombre} ${cliente.apellido}`);
                        setClientesFiltrados([]);
                      }}
                      className="p-2 hover:bg-gray-100 cursor-pointer"
                    >
                      {cliente.nombre} {cliente.apellido} - {cliente.telefono}
                    </div>
                  ))}
                </div>
              )}
              {clienteSeleccionado && (
                <div className="bg-gray-100 p-2 rounded text-sm">
                  <strong>{clienteSeleccionado.nombre} {clienteSeleccionado.apellido}</strong><br/>
                  {clienteSeleccionado.direccion.calle} {clienteSeleccionado.direccion.numero}, {clienteSeleccionado.direccion.localidad}
                </div>
              )}
            </div>

            {/* Productos */}
            <div className="space-y-2">
              <label className="font-semibold">Productos:</label>
              {formData.productos.map((producto, index) => (
                <div key={index} className="flex gap-2 items-center">
                  <select
                    value={producto.productoId}
                    onChange={(e) => actualizarProducto(index, 'productoId', e.target.value)}
                    className="flex-1 border rounded p-2"
                    required
                  >
                    <option value="">Seleccionar producto</option>
                    {productos.map(p => (
                      <option key={p.id} value={p.id}>{p.nombre}</option>
                    ))}
                  </select>
                  <input
                    type="number"
                    min="1"
                    placeholder="Cant."
                    value={producto.cantidad}
                    onChange={(e) => actualizarProducto(index, 'cantidad', parseInt(e.target.value))}
                    className="w-16 border rounded p-2"
                  />
                  <input
                    type="number"
                    step="0.01"
                    placeholder="Precio"
                    value={producto.precioUnitario}
                    onChange={(e) => actualizarProducto(index, 'precioUnitario', parseFloat(e.target.value))}
                    className="w-20 border rounded p-2"
                  />
                  {formData.productos.length > 1 && (
                    <button
                      type="button"
                      onClick={() => eliminarProducto(index)}
                      className="text-red-600 hover:text-red-800"
                    >
                      ✕
                    </button>
                  )}
                </div>
              ))}
              <button
                type="button"
                onClick={agregarProducto}
                className="text-blue-600 hover:text-blue-800 text-sm"
              >
                + Agregar producto
              </button>
            </div>

            {/* Detalles del pedido */}
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-semibold">Costo de Envío:</label>
                <input
                  type="number"
                  step="0.01"
                  value={formData.costoEnvio}
                  onChange={(e) => setFormData({...formData, costoEnvio: e.target.value})}
                  className="w-full border rounded p-2"
                />
              </div>
              <div>
                <label className="block text-sm font-semibold">Total: ${calcularTotal().toFixed(2)}</label>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-semibold">Fecha de Entrega:</label>
                <input
                  type="date"
                  value={formData.fechaEntrega}
                  onChange={(e) => setFormData({...formData, fechaEntrega: e.target.value})}
                  className="w-full border rounded p-2"
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-semibold">Turno:</label>
                <select
                  value={formData.turno}
                  onChange={(e) => setFormData({...formData, turno: e.target.value})}
                  className="w-full border rounded p-2"
                >
                  <option value="mañana">Mañana</option>
                  <option value="tarde">Tarde</option>
                </select>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-semibold">Forma de Pago:</label>
                <select
                  value={formData.formaPago}
                  onChange={(e) => setFormData({...formData, formaPago: e.target.value})}
                  className="w-full border rounded p-2"
                >
                  <option value="efectivo">Efectivo</option>
                  <option value="mercadopago">Mercado Pago</option>
                  <option value="transferencia">Transferencia</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-semibold">Pagado a Cuenta:</label>
                <input
                  type="number"
                  step="0.01"
                  value={formData.pagadoACuenta}
                  onChange={(e) => setFormData({...formData, pagadoACuenta: e.target.value})}
                  className="w-full border rounded p-2"
                />
              </div>
            </div>

            <div className="flex gap-2">
              <button type="submit" className="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                Guardar Pedido
              </button>
              <button type="button" onClick={onCancel} className="flex-1 bg-gray-300 py-2 rounded hover:bg-gray-400">
                Cancelar
              </button>
            </div>
          </form>
        </div>
      </div>
    );
  };

  // Funciones para manejar formularios
  const handleSaveCliente = (cliente) => {
    if (cliente.id && clientes.find(c => c.id === cliente.id)) {
      setClientes(clientes.map(c => c.id === cliente.id ? cliente : c));
    } else {
      if (!cliente.id) cliente.id = Math.max(...clientes.map(c => c.id), 0) + 1;
      setClientes([...clientes, cliente]);
    }
    setShowClienteForm(false);
  };

  const handleSaveProducto = (producto) => {
    if (productos.find(p => p.id === producto.id)) {
      setProductos(productos.map(p => p.id === producto.id ? producto : p));
    } else {
      setProductos([...productos, producto]);
    }
    setShowProductoForm(false);
  };

  const handleSavePedido = (pedido) => {
    if (pedidos.find(p => p.id === pedido.id)) {
      setPedidos(pedidos.map(p => p.id === pedido.id ? pedido : p));
    } else {
      setPedidos([...pedidos, pedido]);
    }
    setShowPedidoForm(false);
  };

  // Función para generar estadísticas
  const generarEstadisticas = () => {
    const stats = {
      pedidosPendientes: pedidos.filter(p => p.estado === 'pendiente').length,
      pedidosConSaldo: pedidos.filter(p => p.saldoPendiente > 0).length,
      totalVentas: pedidos.reduce((sum, p) => sum + p.total, 0),
      clientesActivos: clientes.length,
      productosMasVendidos: {}
    };

    // Calcular productos más vendidos
    pedidos.forEach(pedido => {
      pedido.productos.forEach(item => {
        const producto = productos.find(p => p.id === item.productoId);
        if (producto) {
          stats.productosMasVendidos[producto.nombre] = 
            (stats.productosMasVendidos[producto.nombre] || 0) + item.cantidad;
        }
      });
    });

    return stats;
  };

  // Renderizar sección activa
  const renderSection = () => {
    switch (activeSection) {
      case 'clientes':
        return (
          <div className="space-y-4">
            <div className="flex justify-between items-center">
              <h2 className="text-xl font-bold">Clientes</h2>
              <button
                onClick={() => setShowClienteForm(true)}
                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2"
              >
                <Plus size={16} /> Nuevo Cliente
              </button>
            </div>
            
            <div className="grid gap-4">
              {clientes.map(cliente => (
                <div key={cliente.id} className="border rounded p-4 bg-white shadow-sm">
                  <div className="flex justify-between items-start">
                    <div>
                      <h3 className="font-semibold">{cliente.nombre} {cliente.apellido}</h3>
                      <p className="text-sm text-gray-600 flex items-center gap-1">
                        <Phone size={14} /> {cliente.telefono}
                      </p>
                      <p className="text-sm text-gray-600 flex items-center gap-1">
                        <MapPin size={14} /> {cliente.direccion.calle} {cliente.direccion.numero}, {cliente.direccion.localidad}
                      </p>
                      {cliente.email && (
                        <p className="text-sm text-gray-600 flex items-center gap-1">
                          <Mail size={14} /> {cliente.email}
                        </p>
                      )}
                    </div>
                    <span className="text-xs bg-gray-100 px-2 py-1 rounded">#{cliente.id}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        );

      case 'productos':
        return (
          <div className="space-y-4">
            <div className="flex justify-between items-center">
              <h2 className="text-xl font-bold">Productos</h2>
              <button
                onClick={() => setShowProductoForm(true)}
                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2"
              >
                <Plus size={16} /> Nuevo Producto
              </button>
            </div>
            
            <div className="grid gap-4">
              {productos.map(producto => (
                <div key={producto.id} className="border rounded p-4 bg-white shadow-sm">
                  <div className="flex justify-between items-start">
                    <div>
                      <h3 className="font-semibold">{producto.nombre}</h3>
                      <p className="text-sm text-gray-600">ID: {producto.id}</p>
                      <div className="mt-2">
                        <p className="text-xs font-semibold text-gray-700">Componentes:</p>
                        {producto.componentes.map((comp, idx) => (
                          <p key={idx} className="text-xs text-gray-600">
                            • {comp.item}: {comp.cantidad} {comp.unidad}
                          </p>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        );

      case 'pedidos':
        return (
          <div className="space-y-4">
            <div className="flex justify-between items-center">
              <h2 className="text-xl font-bold">Pedidos</h2>
              <button
                onClick={() => setShowPedidoForm(true)}
                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2"
              >
                <Plus size={16} /> Nuevo Pedido
              </button>
            </div>
            
            <div className="grid gap-4">
              {pedidos.map(pedido => {
                const cliente = clientes.find(c => c.id.toString() === pedido.clienteId.toString());
                return (
                  <div key={pedido.id} className="border rounded p-4 bg-white shadow-sm">
                    <div className="flex justify-between items-start mb-2">
                      <div>
                        <h3 className="font-semibold">
                          {cliente ? `${cliente.nombre} ${cliente.apellido}` : 'Cliente no encontrado'}
                        </h3>
                        <p className="text-sm text-gray-600">Pedido #{pedido.id}</p>
                      </div>
                      <div className="text-right">
                        <p className="font-semibold">${pedido.total.toFixed(2)}</p>
                        {pedido.saldoPendiente > 0 && (
                          <p className="text-sm text-red-600">Saldo: ${pedido.saldoPendiente.toFixed(2)}</p>
                        )}
                      </div>
                    </div>
                    
                    <div className="text-sm space-y-1">
                      <p><strong>Productos:</strong></p>
                      {pedido.productos.map((item, idx) => {
                        const producto = productos.find(p => p.id === item.productoId);
                        return (
                          <p key={idx} className="text-gray-600 ml-2">
                            • {producto?.nombre || 'Producto no encontrado'
