// FORMULARIO PEDIDOS COMPLETO
const PedidoForm = () => {
    const [data, setData] = useState(editing || { 
        clienteId: '',
        productos: [{ productoId: '', cantidad: 1, precioUnitario: 0 }],
        direccionEntrega: '',
        fechaEntrega: '',
        turno: 'mañana',
        estado: 'pendiente',
        costoEnvio: 0,
        subtotal: 0,
        total: 0,
        metodoPago: 'efectivo',
        notasEspeciales: '',
        fechaCreacion: new Date().toISOString().split('T')[0]
    });

    // Cargar dirección del cliente seleccionado
    useEffect(() => {
        if (data.clienteId && clientes.length > 0) {
            const cliente = clientes.find(c => c.id === data.clienteId);
            if (cliente && !editing) {
                const direccion = `${cliente.calle || ''} ${cliente.numero || ''} ${cliente.piso ? ', ' + cliente.piso : ''}, ${cliente.localidad || ''} (${cliente.codigoPostal || ''})`.trim();
                setData(prev => ({...prev, direccionEntrega: direccion}));
            }
        }
    }, [data.clienteId, clientes]);

    const addProducto = () => {
        setData({
            ...data,
            productos: [...data.productos, { productoId: '', cantidad: 1, precioUnitario: 0 }]
        });
    };

    const removeProducto = (index) => {
        if (data.productos.length > 1) {
            const newProductos = data.productos.filter((_, i) => i !== index);
            setData({...data, productos: newProductos});
            calcularTotales(newProductos, data.costoEnvio);
        }
    };

    const updateProducto = (index, field, value) => {
        const newProductos = [...data.productos];
        
        if (field === 'productoId') {
            // Auto-completar precio cuando se selecciona producto
            const producto = productos.find(p => p.id === value);
            newProductos[index] = {
                ...newProductos[index],
                productoId: value,
                precioUnitario: producto ? parseFloat(producto.precio) : 0
            };
        } else {
            newProductos[index][field] = field === 'cantidad' || field === 'precioUnitario' ? parseFloat(value) || 0 : value;
        }
        
        setData({...data, productos: newProductos});
        calcularTotales(newProductos, data.costoEnvio);
    };

    const calcularTotales = (productos = data.productos, envio = data.costoEnvio) => {
        const subtotal = productos.reduce((sum, p) => sum + (p.cantidad * p.precioUnitario), 0);
        const total = subtotal + parseFloat(envio || 0);
        setData(prev => ({
            ...prev, 
            subtotal: subtotal,
            total: total
        }));
    };

    const handleCostoEnvioChange = (valor) => {
        const envio = parseFloat(valor) || 0;
        setData(prev => ({...prev, costoEnvio: envio}));
        calcularTotales(data.productos, envio);
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        
        // Validaciones
        if (!data.clienteId) {
            alert('Por favor selecciona un cliente');
            return;
        }
        if (!data.productos[0].productoId) {
            alert('Por favor agrega al menos un producto');
            return;
        }
        if (!data.fechaEntrega) {
            alert('Por favor selecciona fecha de entrega');
            return;
        }
        if (!data.direccionEntrega.trim()) {
            alert('Por favor completa la dirección de entrega');
            return;
        }

        // Validar que todos los productos tengan cantidad > 0
        const productosValidos = data.productos.every(p => p.productoId && p.cantidad > 0);
        if (!productosValidos) {
            alert('Todos los productos deben tener cantidad mayor a 0');
            return;
        }

        saveData('pedidos', data);
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-6">
            <h3 className="text-xl font-bold mb-4">
                {editing ? 'Editar Pedido' : 'Nuevo Pedido'}
            </h3>

            {/* CLIENTE Y ESTADO */}
            <div className="bg-blue-50 p-4 rounded">
                <h4 className="font-semibold mb-3">Cliente y Estado</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium mb-1">Cliente *</label>
                        <select 
                            value={data.clienteId} 
                            onChange={(e) => setData({...data, clienteId: e.target.value})} 
                            className="w-full p-2 border rounded" 
                            required
                        >
                            <option value="">Seleccionar Cliente</option>
                            {clientes.map(c => (
                                <option key={c.id} value={c.id}>
                                    {c.nombre} {c.apellido} - {c.telefono}
                                </option>
                            ))}
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-1">Estado del Pedido</label>
                        <select 
                            value={data.estado} 
                            onChange={(e) => setData({...data, estado: e.target.value})} 
                            className="w-full p-2 border rounded"
                        >
                            <option value="pendiente">Pendiente</option>
                            <option value="en_preparacion">En Preparación</option>
                            <option value="listo">Listo</option>
                            <option value="entregado">Entregado</option>
                        </select>
                    </div>
                </div>
            </div>

            {/* PRODUCTOS */}
            <div className="bg-green-50 p-4 rounded">
                <div className="flex justify-between items-center mb-3">
                    <h4 className="font-semibold">Productos *</h4>
                    <button 
                        type="button" 
                        onClick={addProducto} 
                        className="bg-green-500 text-white px-3 py-1 rounded text-sm"
                    >
                        + Agregar Producto
                    </button>
                </div>

                {data.productos.map((producto, index) => (
                    <div key={index} className="bg-white p-3 rounded mb-2 border">
                        <div className="grid grid-cols-1 md:grid-cols-5 gap-2">
                            <div className="md:col-span-2">
                                <select 
                                    value={producto.productoId} 
                                    onChange={(e) => updateProducto(index, 'productoId', e.target.value)} 
                                    className="w-full p-2 border rounded"
                                    required
                                >
                                    <option value="">Seleccionar Producto</option>
                                    {productos.map(p => (
                                        <option key={p.id} value={p.id}>
                                            {p.nombre} - ${p.precio} ({p.stock} {p.tipoMedida})
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <input 
                                type="number" 
                                placeholder="Cantidad" 
                                value={producto.cantidad} 
                                onChange={(e) => updateProducto(index, 'cantidad', e.target.value)} 
                                className="w-full p-2 border rounded" 
                                min="1"
                                required
                            />
                            <input 
                                type="number"
                                step="0.01"
                                placeholder="Precio Unit." 
                                value={producto.precioUnitario} 
                                onChange={(e) => updateProducto(index, 'precioUnitario', e.target.value)} 
                                className="w-full p-2 border rounded" 
                                required
                            />
                            <div className="flex items-center justify-between">
                                <span className="font-bold text-green-600">
                                    ${(producto.cantidad * producto.precioUnitario).toFixed(2)}
                                </span>
                                {data.productos.length > 1 && (
                                    <button 
                                        type="button" 
                                        onClick={() => removeProducto(index)} 
                                        className="bg-red-500 text-white px-2 py-1 rounded text-sm ml-2"
                                    >
                                        ×
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                ))}
            </div>

            {/* ENTREGA */}
            <div className="bg-yellow-50 p-4 rounded">
                <h4 className="font-semibold mb-3">Información de Entrega</h4>
                <div className="space-y-3">
                    <div>
                        <label className="block text-sm font-medium mb-1">Dirección de Entrega *</label>
                        <textarea 
                            placeholder="Dirección completa de entrega" 
                            value={data.direccionEntrega} 
                            onChange={(e) => setData({...data, direccionEntrega: e.target.value})} 
                            className="w-full p-2 border rounded h-20"
                            required
                        />
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div>
                            <label className="block text-sm font-medium mb-1">Fecha de Entrega *</label>
                            <input 
                                type="date" 
                                value={data.fechaEntrega} 
                                onChange={(e) => setData({...data, fechaEntrega: e.target.value})} 
                                className="w-full p-2 border rounded" 
                                min={new Date().toISOString().split('T')[0]}
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">Turno</label>
                            <select 
                                value={data.turno} 
                                onChange={(e) => setData({...data, turno: e.target.value})} 
                                className="w-full p-2 border rounded"
                            >
                                <option value="mañana">Mañana (8:00 - 12:00)</option>
                                <option value="tarde">Tarde (14:00 - 18:00)</option>
                                <option value="noche">Noche (18:00 - 22:00)</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-1">Notas Especiales</label>
                        <textarea 
                            placeholder="Instrucciones especiales (ej: sin cebolla, tocar timbre, etc.)" 
                            value={data.notasEspeciales} 
                            onChange={(e) => setData({...data, notasEspeciales: e.target.value})} 
                            className="w-full p-2 border rounded h-16"
                        />
                    </div>
                </div>
            </div>

            {/* TOTALES Y PAGO */}
            <div className="bg-purple-50 p-4 rounded">
                <h4 className="font-semibold mb-3">Totales y Pago</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="space-y-2">
                        <div>
                            <label className="block text-sm font-medium mb-1">Costo de Envío</label>
                            <input 
                                type="number"
                                step="0.01"
                                placeholder="0.00" 
                                value={data.costoEnvio} 
                                onChange={(e) => handleCostoEnvioChange(e.target.value)} 
                                className="w-full p-2 border rounded" 
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">Método de Pago</label>
                            <select 
                                value={data.metodoPago} 
                                onChange={(e) => setData({...data, metodoPago: e.target.value})} 
                                className="w-full p-2 border rounded"
                            >
                                <option value="efectivo">Efectivo</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="mercadopago">Mercado Pago</option>
                                <option value="tarjeta">Tarjeta</option>
                            </select>
                        </div>
                    </div>
                    <div className="bg-white p-3 rounded border">
                        <div className="space-y-2">
                            <div className="flex justify-between">
                                <span>Subtotal:</span>
                                <span className="font-semibold">${data.subtotal.toFixed(2)}</span>
                            </div>
                            <div className="flex justify-between">
                                <span>Envío:</span>
                                <span className="font-semibold">${data.costoEnvio.toFixed(2)}</span>
                            </div>
                            <hr />
                            <div className="flex justify-between text-lg font-bold text-green-600">
                                <span>TOTAL:</span>
                                <span>${data.total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* BOTONES */}
            <div className="flex gap-2 pt-4">
                <button 
                    type="submit" 
                    className="bg-orange-500 text-white px-6 py-2 rounded font-semibold"
                >
                    {editing ? 'Actualizar Pedido' : 'Crear Pedido'}
                </button>
                <button 
                    type="button" 
                    onClick={() => setModal(false)} 
                    className="bg-gray-500 text-white px-6 py-2 rounded"
                >
                    Cancelar
                </button>
            </div>
        </form>
    );
};
